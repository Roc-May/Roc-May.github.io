<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Matlab中将二进制文本转为十进制文本单独保存</title>
      <link href="2021/09/08/matlab-zhong-jiang-er-jin-zhi-wen-ben-zhuan-wei-shi-jin-zhi-wen-ben-dan-du-bao-cun/"/>
      <url>2021/09/08/matlab-zhong-jiang-er-jin-zhi-wen-ben-zhuan-wei-shi-jin-zhi-wen-ben-dan-du-bao-cun/</url>
      
        <content type="html"><![CDATA[<h2 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h2><pre class=" language-bash"><code class="language-bash"><span class="token function">clear</span>clcinstr <span class="token operator">=</span> zeros<span class="token punctuation">(</span>512,1<span class="token punctuation">)</span><span class="token punctuation">;</span>fidy<span class="token operator">=</span>fopen<span class="token punctuation">(</span><span class="token string">'data.txt'</span>,<span class="token string">'r'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>i <span class="token operator">=</span> 1<span class="token punctuation">;</span><span class="token keyword">while</span> feof<span class="token punctuation">(</span>fidy<span class="token punctuation">)</span> <span class="token operator">==</span> 0    line <span class="token operator">=</span> fgetl<span class="token punctuation">(</span>fidy<span class="token punctuation">)</span><span class="token punctuation">;</span> instr<span class="token punctuation">(</span>i<span class="token punctuation">)</span> <span class="token operator">=</span> bin2dec<span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span> i <span class="token operator">=</span> i+1<span class="token punctuation">;</span>    <span class="token keyword">continue</span><span class="token punctuation">;</span>endfclose<span class="token punctuation">(</span>fidy<span class="token punctuation">)</span><span class="token punctuation">;</span>disp<span class="token punctuation">(</span><span class="token string">'no wrong'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>fidx<span class="token operator">=</span>fopen<span class="token punctuation">(</span><span class="token string">'data_dec.txt'</span>,<span class="token string">'w'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> i <span class="token operator">=</span> 1:512 fprintf<span class="token punctuation">(</span>fidx, <span class="token string">'%d\n'</span>, instr<span class="token punctuation">(</span>i<span class="token punctuation">))</span><span class="token punctuation">;</span>end</code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>基于FPGA的俄罗斯方块</title>
      <link href="2021/09/07/ji-yu-fpga-de-e-luo-si-fang-kuai/"/>
      <url>2021/09/07/ji-yu-fpga-de-e-luo-si-fang-kuai/</url>
      
        <content type="html"><![CDATA[<h2 id="vh文件"><a href="#vh文件" class="headerlink" title="vh文件"></a>vh文件</h2><p>   definitions.vh</p><pre class=" language-verilog"><code class="language-verilog"><span class="token comment" spellcheck="true">// The width of the screen in pixels</span><span class="token constant">`define</span> PIXEL_WIDTH <span class="token number">640</span><span class="token comment" spellcheck="true">// The height of the screen in pixels</span><span class="token constant">`define</span> PIXEL_HEIGHT <span class="token number">480</span><span class="token comment" spellcheck="true">// Used for VGA horizontal and vertical sync</span><span class="token constant">`define</span> HSYNC_FRONT_PORCH <span class="token number">16</span><span class="token constant">`define</span> HSYNC_PULSE_WIDTH <span class="token number">96</span><span class="token constant">`define</span> HSYNC_BACK_PORCH <span class="token number">48</span><span class="token constant">`define</span> VSYNC_FRONT_PORCH <span class="token number">10</span><span class="token constant">`define</span> VSYNC_PULSE_WIDTH <span class="token number">2</span><span class="token constant">`define</span> VSYNC_BACK_PORCH <span class="token number">33</span><span class="token comment" spellcheck="true">// How many pixels wide/high each block is</span><span class="token constant">`define</span> BLOCK_SIZE <span class="token number">20</span><span class="token comment" spellcheck="true">// How many blocks wide the game board is</span><span class="token constant">`define</span> BLOCKS_WIDE <span class="token number">10</span><span class="token comment" spellcheck="true">// How many blocks high the game board is</span><span class="token constant">`define</span> BLOCKS_HIGH <span class="token number">22</span><span class="token comment" spellcheck="true">// Width of the game board in pixels</span><span class="token constant">`define</span> BOARD_WIDTH <span class="token punctuation">(</span><span class="token constant">`BLOCKS_WIDE</span> <span class="token operator">*</span> <span class="token constant">`BLOCK_SIZE</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// Starting x pixel for the game board</span><span class="token constant">`define</span> BOARD_X <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">`PIXEL_WIDTH</span> <span class="token operator">-</span> <span class="token constant">`BOARD_WIDTH</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// Height of the game board in pixels</span><span class="token constant">`define</span> BOARD_HEIGHT <span class="token punctuation">(</span><span class="token constant">`BLOCKS_HIGH</span> <span class="token operator">*</span> <span class="token constant">`BLOCK_SIZE</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// Starting y pixel for the game board</span><span class="token constant">`define</span> BOARD_Y <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token constant">`PIXEL_HEIGHT</span> <span class="token operator">-</span> <span class="token constant">`BOARD_HEIGHT</span><span class="token punctuation">)</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">// The number of bits used to store a block position</span><span class="token constant">`define</span> BITS_BLK_POS <span class="token number">8</span><span class="token comment" spellcheck="true">// The number of bits used to store an X position</span><span class="token constant">`define</span> BITS_X_POS <span class="token number">4</span><span class="token comment" spellcheck="true">// The number of bits used to store a Y position</span><span class="token constant">`define</span> BITS_Y_POS <span class="token number">5</span><span class="token comment" spellcheck="true">// The number of bits used to store a rotation</span><span class="token constant">`define</span> BITS_ROT <span class="token number">2</span><span class="token comment" spellcheck="true">// The number of bits used to store how wide / long a block is (max of decimal 4)</span><span class="token constant">`define</span> BITS_BLK_SIZE <span class="token number">3</span><span class="token comment" spellcheck="true">// The number of bits for the score. The score goes up to 10000</span><span class="token constant">`define</span> BITS_SCORE <span class="token number">14</span><span class="token comment" spellcheck="true">// The number of bits used to store each block</span><span class="token constant">`define</span> BITS_PER_BLOCK <span class="token number">3</span><span class="token comment" spellcheck="true">// The type of each block</span><span class="token constant">`define</span> EMPTY_BLOCK <span class="token number">3'b000</span><span class="token constant">`define</span> I_BLOCK <span class="token number">3'b001</span><span class="token constant">`define</span> O_BLOCK <span class="token number">3'b010</span><span class="token constant">`define</span> T_BLOCK <span class="token number">3'b011</span><span class="token constant">`define</span> S_BLOCK <span class="token number">3'b100</span><span class="token constant">`define</span> Z_BLOCK <span class="token number">3'b101</span><span class="token constant">`define</span> J_BLOCK <span class="token number">3'b110</span><span class="token constant">`define</span> L_BLOCK <span class="token number">3'b111</span><span class="token comment" spellcheck="true">// Color mapping</span><span class="token constant">`define</span> WHITE <span class="token number">8'b11111111</span><span class="token constant">`define</span> BLACK <span class="token number">8'b00000000</span><span class="token constant">`define</span> GRAY <span class="token number">8'b10100100</span><span class="token constant">`define</span> CYAN <span class="token number">8'b11110000</span><span class="token constant">`define</span> YELLOW <span class="token number">8'b00111111</span><span class="token constant">`define</span> PURPLE <span class="token number">8'b11000111</span><span class="token constant">`define</span> GREEN <span class="token number">8'b00111000</span><span class="token constant">`define</span> RED <span class="token number">8'b00000111</span><span class="token constant">`define</span> BLUE <span class="token number">8'b11000000</span><span class="token constant">`define</span> ORANGE <span class="token number">8'b00011111</span><span class="token comment" spellcheck="true">// Error value</span><span class="token constant">`define</span> ERR_BLK_POS <span class="token number">8'b11111111</span><span class="token comment" spellcheck="true">// Modes</span><span class="token constant">`define</span> MODE_BITS <span class="token number">3</span><span class="token constant">`define</span> MODE_PLAY <span class="token number">0</span><span class="token constant">`define</span> MODE_DROP <span class="token number">1</span><span class="token constant">`define</span> MODE_PAUSE <span class="token number">2</span><span class="token constant">`define</span> MODE_IDLE <span class="token number">3</span><span class="token constant">`define</span> MODE_SHIFT <span class="token number">4</span><span class="token comment" spellcheck="true">// The maximum value of the drop timer</span><span class="token constant">`define</span> DROP_TIMER_MAX <span class="token number">10000</span></code></pre><h2 id="calc-cur-blk-v"><a href="#calc-cur-blk-v" class="headerlink" title="calc_cur_blk.v"></a>calc_cur_blk.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`include</span> <span class="token string">"definitions.vh"</span><span class="token keyword">module</span> <span class="token function">calc_cur_blk</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_PER_BLOCK</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> piece<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> pos_x<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> pos_y<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> rot<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk_1<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk_2<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk_3<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk_4<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> width<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> height    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token keyword">case</span> <span class="token punctuation">(</span>piece<span class="token punctuation">)</span>            <span class="token constant">`EMPTY_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                 blk_1 <span class="token operator">=</span> <span class="token constant">`ERR_BLK_POS</span><span class="token punctuation">;</span>                 blk_2 <span class="token operator">=</span> <span class="token constant">`ERR_BLK_POS</span><span class="token punctuation">;</span>                 blk_3 <span class="token operator">=</span> <span class="token constant">`ERR_BLK_POS</span><span class="token punctuation">;</span>                 blk_4 <span class="token operator">=</span> <span class="token constant">`ERR_BLK_POS</span><span class="token punctuation">;</span>                 width <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>                 height <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>            <span class="token constant">`I_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                 <span class="token keyword">if</span> <span class="token punctuation">(</span>rot <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> rot <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                     blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                     blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                     blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                     blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                     width <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                     height <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>                 <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                     blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                     blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                     blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                     blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">3</span><span class="token punctuation">;</span>                     width <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>                     height <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>                 <span class="token keyword">end</span>            <span class="token keyword">end</span>            <span class="token constant">`O_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>            <span class="token constant">`T_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                <span class="token keyword">case</span> <span class="token punctuation">(</span>rot<span class="token punctuation">)</span>                    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">3</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                <span class="token keyword">endcase</span>            <span class="token keyword">end</span>            <span class="token constant">`S_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>rot <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> rot <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                    blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                    blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                    blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                    blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                    blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                    blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                <span class="token keyword">end</span>            <span class="token keyword">end</span>            <span class="token constant">`Z_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>rot <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> rot <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                    blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                    blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                    width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                    blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                    blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                    blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                <span class="token keyword">end</span>            <span class="token keyword">end</span>            <span class="token constant">`J_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                <span class="token keyword">case</span> <span class="token punctuation">(</span>rot<span class="token punctuation">)</span>                    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">3</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                <span class="token keyword">endcase</span>            <span class="token keyword">end</span>            <span class="token constant">`L_BLOCK</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                <span class="token keyword">case</span> <span class="token punctuation">(</span>rot<span class="token punctuation">)</span>                    <span class="token number">0</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">1</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">2</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                    <span class="token number">3</span><span class="token punctuation">:</span> <span class="token keyword">begin</span>                        blk_1 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x<span class="token punctuation">;</span>                        blk_2 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        blk_3 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        blk_4 <span class="token operator">=</span> <span class="token punctuation">(</span>pos_y <span class="token operator">*</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span> <span class="token operator">+</span> pos_x <span class="token operator">+</span> <span class="token number">2</span><span class="token punctuation">;</span>                        width <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>                        height <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                <span class="token keyword">endcase</span>            <span class="token keyword">end</span>        <span class="token keyword">endcase</span>    <span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre><h2 id="calc-test-pos-rot-v"><a href="#calc-test-pos-rot-v" class="headerlink" title="calc_test_pos_rot.v"></a>calc_test_pos_rot.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`include</span> <span class="token string">"definitions.vh"</span><span class="token keyword">module</span> <span class="token function">calc_test_pos_rot</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`MODE_BITS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>  mode<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                   game_clk_rst<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                   game_clk<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                   btn_left_en<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                   btn_right_en<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                   btn_rotate_en<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                   btn_down_en<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                   btn_drop_en<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_X_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_pos_x<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_Y_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_pos_y<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_ROT</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>   cur_rot<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_X_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_pos_x<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_Y_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_pos_y<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_ROT</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>   test_rot    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>game_clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>                test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>                test_pos_y <span class="token operator">=</span> cur_pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// move down</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_left_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                test_pos_x <span class="token operator">=</span> cur_pos_x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// move left</span>                test_pos_y <span class="token operator">=</span> cur_pos_y<span class="token punctuation">;</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_right_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                test_pos_x <span class="token operator">=</span> cur_pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// move right</span>                test_pos_y <span class="token operator">=</span> cur_pos_y<span class="token punctuation">;</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_rotate_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>                test_pos_y <span class="token operator">=</span> cur_pos_y<span class="token punctuation">;</span>                test_rot <span class="token operator">=</span> cur_rot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// rotate</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_down_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>                test_pos_y <span class="token operator">=</span> cur_pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// move down</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_drop_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token comment" spellcheck="true">// do nothing, we set to drop mode</span>                test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>                test_pos_y <span class="token operator">=</span> cur_pos_y<span class="token punctuation">;</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                <span class="token comment" spellcheck="true">// do nothing, the block isn't moving this cycle</span>                test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>                test_pos_y <span class="token operator">=</span> cur_pos_y<span class="token punctuation">;</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">`MODE_DROP</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>game_clk_rst<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token comment" spellcheck="true">// do nothing, we set to play mode</span>                test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>                test_pos_y <span class="token operator">=</span> cur_pos_y<span class="token punctuation">;</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>                test_pos_y <span class="token operator">=</span> cur_pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// move down</span>                test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// Other mode, do nothing</span>            test_pos_x <span class="token operator">=</span> cur_pos_x<span class="token punctuation">;</span>            test_pos_y <span class="token operator">=</span> cur_pos_y<span class="token punctuation">;</span>            test_rot <span class="token operator">=</span> cur_rot<span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre><h2 id="complete-row-v"><a href="#complete-row-v" class="headerlink" title="complete_row.v"></a>complete_row.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`include</span> <span class="token string">"definitions.vh"</span><span class="token keyword">module</span> <span class="token function">complete_row</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                                   clk<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                                   pause<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token constant">`BLOCKS_WIDE</span><span class="token operator">*</span><span class="token constant">`BLOCKS_HIGH</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> fallen_pieces<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_Y_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>                 row<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>                                  enabled    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">initial</span> <span class="token keyword">begin</span>        row <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>     <span class="token comment" spellcheck="true">// Enabled is high when the current row is complete (all 1s)</span>     <span class="token keyword">assign</span> enabled <span class="token operator">=</span> <span class="token operator">&amp;</span>fallen_pieces<span class="token punctuation">[</span>row<span class="token operator">*</span><span class="token constant">`BLOCKS_WIDE</span> <span class="token operator">+</span><span class="token punctuation">:</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>     <span class="token comment" spellcheck="true">// Increment the row under test when the clock goes high</span>     <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pause<span class="token punctuation">)</span> <span class="token keyword">begin</span>             <span class="token keyword">if</span> <span class="token punctuation">(</span>row <span class="token operator">==</span> <span class="token constant">`BLOCKS_HIGH</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                 row <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>             <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                 row <span class="token operator">&lt;=</span> row <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>             <span class="token keyword">end</span>         <span class="token keyword">end</span>     <span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre><h2 id="debouncer-v"><a href="#debouncer-v" class="headerlink" title="debouncer.v"></a>debouncer.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token keyword">module</span> <span class="token function">debouncer</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>  raw<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>  clk<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> enabled<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> disabled    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">reg</span> debounced<span class="token punctuation">;</span>    <span class="token keyword">reg</span> debounced_prev<span class="token punctuation">;</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> counter<span class="token punctuation">;</span>    <span class="token keyword">initial</span> <span class="token keyword">begin</span>        debounced <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        debounced_prev <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        counter <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token comment" spellcheck="true">// 200 Hz</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">==</span> <span class="token number">12500</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            debounced <span class="token operator">&lt;=</span> raw<span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>            counter <span class="token operator">&lt;=</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>        <span class="token comment" spellcheck="true">// Update previous</span>        debounced_prev <span class="token operator">&lt;=</span> debounced<span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token keyword">assign</span> enabled <span class="token operator">=</span> debounced <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>debounced_prev<span class="token punctuation">;</span>    <span class="token keyword">assign</span> disabled <span class="token operator">=</span> <span class="token operator">!</span>debounced <span class="token operator">&amp;&amp;</span> debounced_prev<span class="token punctuation">;</span><span class="token keyword">endmodule</span></code></pre><h2 id="game-clock-v"><a href="#game-clock-v" class="headerlink" title="game_clock.v"></a>game_clock.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token keyword">module</span> <span class="token function">game_clock</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> clk<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> rst<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> pause<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> game_clk    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> counter<span class="token punctuation">;</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pause<span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>rst<span class="token punctuation">)</span> <span class="token keyword">begin</span>                counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                game_clk <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">==</span> <span class="token number">25000000</span><span class="token punctuation">)</span> <span class="token keyword">begin</span> <span class="token comment" spellcheck="true">// 1 Hz</span>                    counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    game_clk <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>                <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                    counter <span class="token operator">&lt;=</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    game_clk <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">end</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre><h2 id="randomizer-v"><a href="#randomizer-v" class="headerlink" title="randomizer.v"></a>randomizer.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token keyword">module</span> <span class="token function">randomizer</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>       clk<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> random    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">initial</span> <span class="token keyword">begin</span>        random <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token comment" spellcheck="true">// Cycle through values at 100 MHz and select one</span>    <span class="token comment" spellcheck="true">// at user input, which is effectively random.</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>random <span class="token operator">==</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            random <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>            random <span class="token operator">&lt;=</span> random <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre><h2 id="seg-display-v"><a href="#seg-display-v" class="headerlink" title="seg_display.v"></a>seg_display.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`include</span> <span class="token string">"definitions.vh"</span><span class="token keyword">module</span> <span class="token function">seg_display</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>       clk<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_1<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 1's place</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_2<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 10's place</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_3<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 100's place</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_4<span class="token punctuation">,</span> <span class="token comment" spellcheck="true">// 1000's place</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> seg<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> an    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Divide the clock so we get a seg_clk that goes</span>    <span class="token comment" spellcheck="true">// at a couple hundred Hz for displaying the next digit</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">17</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> counter<span class="token punctuation">;</span>    <span class="token keyword">reg</span> seg_clk<span class="token punctuation">;</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>counter <span class="token operator">==</span> <span class="token number">50000</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            counter <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            seg_clk <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>            counter <span class="token operator">&lt;=</span> counter <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            seg_clk <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span>    <span class="token comment" spellcheck="true">// Which digit we are currently displaying</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> digit<span class="token punctuation">;</span>    <span class="token keyword">initial</span> <span class="token keyword">begin</span>        digit <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> seg_clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>        digit <span class="token operator">&lt;=</span> digit <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            an <span class="token operator">&lt;=</span> <span class="token number">4'b0111</span><span class="token punctuation">;</span>            <span class="token function">display_digit</span><span class="token punctuation">(</span>score_4<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            an <span class="token operator">&lt;=</span> <span class="token number">4'b1011</span><span class="token punctuation">;</span>            <span class="token function">display_digit</span><span class="token punctuation">(</span>score_3<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>digit <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            an <span class="token operator">&lt;=</span> <span class="token number">4'b1101</span><span class="token punctuation">;</span>            <span class="token function">display_digit</span><span class="token punctuation">(</span>score_2<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>            an <span class="token operator">&lt;=</span> <span class="token number">4'b1110</span><span class="token punctuation">;</span>            <span class="token function">display_digit</span><span class="token punctuation">(</span>score_1<span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span>    <span class="token keyword">task</span> display_digit<span class="token punctuation">;</span>        <span class="token keyword">input</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> d<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            <span class="token keyword">case</span> <span class="token punctuation">(</span>d<span class="token punctuation">)</span>                <span class="token number">0</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b11000000</span><span class="token punctuation">;</span>                <span class="token number">1</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b11111001</span><span class="token punctuation">;</span>                <span class="token number">2</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b10100100</span><span class="token punctuation">;</span>                <span class="token number">3</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b10110000</span><span class="token punctuation">;</span>                <span class="token number">4</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b10011001</span><span class="token punctuation">;</span>                <span class="token number">5</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b10010010</span><span class="token punctuation">;</span>                <span class="token number">6</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b10000010</span><span class="token punctuation">;</span>                <span class="token number">7</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b11111000</span><span class="token punctuation">;</span>                <span class="token number">8</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b10000000</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token punctuation">:</span> seg <span class="token operator">&lt;=</span> <span class="token number">8'b10010000</span><span class="token punctuation">;</span>            <span class="token keyword">endcase</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span><span class="token keyword">endmodule</span> <span class="token comment" spellcheck="true">// seg_display</span></code></pre><h2 id="tetris-v"><a href="#tetris-v" class="headerlink" title="tetris.v"></a>tetris.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`include</span> <span class="token string">"definitions.vh"</span><span class="token keyword">module</span> <span class="token function">tetris</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        clk_too_fast<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        btn_drop<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        btn_rotate<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        btn_left<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        btn_right<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        btn_down<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        sw_pause<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>        sw_rst<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> rgb<span class="token punctuation">,</span>    <span class="token comment" spellcheck="true">/*    //////////////////////    input wire sw_red4,    input wire sw_green4,    input wire sw_blue3,    input wire sw_blue4,    //////////////////////    output wire red4,    output wire green4,    output wire blue3,    output wire blue4,    */</span>    <span class="token comment" spellcheck="true">//////////////////////</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>       hsync<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>       vsync<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> seg<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> an    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//////////////////////</span>   <span class="token comment" spellcheck="true">/* assign red4=sw_red4;    assign green4=sw_green4;    assign blue3=sw_blue3;    assign blue4=sw_blue4;*/</span>    <span class="token comment" spellcheck="true">/////////////////////</span>    <span class="token comment" spellcheck="true">// Divides the clock into 25 MHz</span>    <span class="token keyword">reg</span> clk_count<span class="token punctuation">;</span>    <span class="token keyword">reg</span> clk<span class="token punctuation">;</span>    <span class="token keyword">initial</span> <span class="token keyword">begin</span>        clk_count <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        clk <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk_too_fast<span class="token punctuation">)</span> <span class="token keyword">begin</span>        clk_count <span class="token operator">&lt;=</span> <span class="token operator">~</span>clk_count<span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>clk_count<span class="token punctuation">)</span> <span class="token keyword">begin</span>            clk <span class="token operator">&lt;=</span> <span class="token operator">~</span>clk<span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span>    <span class="token comment" spellcheck="true">// Increments once per cycle to a maximum value. If this is</span>    <span class="token comment" spellcheck="true">// not yet at the maximum value, we cannot go into drop mode.</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">31</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> drop_timer<span class="token punctuation">;</span>    <span class="token keyword">initial</span> <span class="token keyword">begin</span>        drop_timer <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token comment" spellcheck="true">// This signal random_piece rotates between the types</span>    <span class="token comment" spellcheck="true">// of pieces at 100 MHz, and is selected based on user input,</span>    <span class="token comment" spellcheck="true">// making it effectively random.</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_PER_BLOCK</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> random_piece<span class="token punctuation">;</span>    randomizer randomizer_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">random</span><span class="token punctuation">(</span>random_piece<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The enable signals for the five buttons, after</span>    <span class="token comment" spellcheck="true">// they have gone through the debouncer. Should only be high</span>    <span class="token comment" spellcheck="true">// for one cycle for each button press.</span>    <span class="token keyword">wire</span> btn_drop_en<span class="token punctuation">;</span>    <span class="token keyword">wire</span> btn_rotate_en<span class="token punctuation">;</span>    <span class="token keyword">wire</span> btn_left_en<span class="token punctuation">;</span>    <span class="token keyword">wire</span> btn_right_en<span class="token punctuation">;</span>    <span class="token keyword">wire</span> btn_down_en<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Debounce all of the input signals</span>    debouncer debouncer_btn_drop_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>btn_drop<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>btn_drop_en<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    debouncer debouncer_btn_rotate_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>btn_rotate<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>btn_rotate_en<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    debouncer debouncer_btn_left_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>btn_left<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>btn_left_en<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    debouncer debouncer_btn_right_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>btn_right<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>btn_right_en<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    debouncer debouncer_btn_down_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>btn_down<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>btn_down_en<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Sets up wires for the pause and reset switch enable</span>    <span class="token comment" spellcheck="true">// and disable signals, and debounces the asynchronous input.</span>    <span class="token keyword">wire</span> sw_pause_en<span class="token punctuation">;</span>    <span class="token keyword">wire</span> sw_pause_dis<span class="token punctuation">;</span>    <span class="token keyword">wire</span> sw_rst_en<span class="token punctuation">;</span>    <span class="token keyword">wire</span> sw_rst_dis<span class="token punctuation">;</span>    debouncer debouncer_sw_pause_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>sw_pause<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>sw_pause_en<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">disabled</span><span class="token punctuation">(</span>sw_pause_dis<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    debouncer debouncer_sw_rst_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">raw</span><span class="token punctuation">(</span>sw_rst<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>sw_rst_en<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">disabled</span><span class="token punctuation">(</span>sw_rst_dis<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// A memory bank for storing 1 bit for each board position.</span>    <span class="token comment" spellcheck="true">// If the fallen_pieces memory is 1, there is a block still that</span>    <span class="token comment" spellcheck="true">// has not been removed from play. This is used to draw the board</span>    <span class="token comment" spellcheck="true">// and to test for intersection with the falling piece.</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token constant">`BLOCKS_WIDE</span><span class="token operator">*</span><span class="token constant">`BLOCKS_HIGH</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> fallen_pieces<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// What type of piece the current falling tetromino is. The types</span>    <span class="token comment" spellcheck="true">// are defined in definitions.vh.</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_PER_BLOCK</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_piece<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The x position of the falling piece.</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_X_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_pos_x<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The y position of the falling piece.</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_Y_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_pos_y<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The current rotation of the falling piece (0 == 0 degrees, 1 == 90 degrees, etc)</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_ROT</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_rot<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The four flattened locations of the current falling tetromino. Used to</span>    <span class="token comment" spellcheck="true">// test for intersection, or add to fallen_pieces, etc.</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_blk_1<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_blk_2<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_blk_3<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_blk_4<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The width and height of the current shape of the tetromino, based on its</span>    <span class="token comment" spellcheck="true">// type and rotation.</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_SIZE</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_width<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_SIZE</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_height<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Use a calc_cur_blk module to get the values of the wires above from</span>    <span class="token comment" spellcheck="true">// the current position, type, and rotation of the falling tetromino.</span>    calc_cur_blk calc_cur_blk_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">piece</span><span class="token punctuation">(</span>cur_piece<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">pos_x</span><span class="token punctuation">(</span>cur_pos_x<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">pos_y</span><span class="token punctuation">(</span>cur_pos_y<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">rot</span><span class="token punctuation">(</span>cur_rot<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_1</span><span class="token punctuation">(</span>cur_blk_1<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_2</span><span class="token punctuation">(</span>cur_blk_2<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_3</span><span class="token punctuation">(</span>cur_blk_3<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_4</span><span class="token punctuation">(</span>cur_blk_4<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span>cur_width<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span>cur_height<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The VGA controller. We give it the type of tetromino (cur_piece)</span>    <span class="token comment" spellcheck="true">// so that it knows the right color, and the four positions on the</span>    <span class="token comment" spellcheck="true">// board that it covers. We also pass in fallen_pieces so that it can</span>    <span class="token comment" spellcheck="true">// display the fallen tetromino squares in monochrome.</span>    vga_display display_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_piece</span><span class="token punctuation">(</span>cur_piece<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_blk_1</span><span class="token punctuation">(</span>cur_blk_1<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_blk_2</span><span class="token punctuation">(</span>cur_blk_2<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_blk_3</span><span class="token punctuation">(</span>cur_blk_3<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_blk_4</span><span class="token punctuation">(</span>cur_blk_4<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">fallen_pieces</span><span class="token punctuation">(</span>fallen_pieces<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">rgb</span><span class="token punctuation">(</span>rgb<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">hsync</span><span class="token punctuation">(</span>hsync<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">vsync</span><span class="token punctuation">(</span>vsync<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The mode, used for finite state machine things. We also</span>    <span class="token comment" spellcheck="true">// need to store the old mode occasionally, like when we're paused.</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`MODE_BITS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> mode<span class="token punctuation">;</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`MODE_BITS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> old_mode<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The game clock</span>    <span class="token keyword">wire</span> game_clk<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The game clock reset</span>    <span class="token keyword">reg</span> game_clk_rst<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// This module outputs the game clock, which is when the clock</span>    <span class="token comment" spellcheck="true">// that determines when the tetromino falls by itself.</span>    game_clock game_clock_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">rst</span><span class="token punctuation">(</span>game_clk_rst<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span>mode <span class="token operator">!=</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">game_clk</span><span class="token punctuation">(</span>game_clk<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Set up some variables to test for intersection or off-screen-ness</span>    <span class="token comment" spellcheck="true">// of the current piece if the user's current action were to be</span>    <span class="token comment" spellcheck="true">// followed through. For example, if the user presses the left button,</span>    <span class="token comment" spellcheck="true">// we test where the current piece would be if it was moved one to the</span>    <span class="token comment" spellcheck="true">// left, i.e. x = x - 1.</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_X_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_pos_x<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_Y_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_pos_y<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_ROT</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_rot<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Combinational logic to determine what position/rotation we are testing.</span>    <span class="token comment" spellcheck="true">// This has been hoisted out into a module so that the code is shorter.</span>    calc_test_pos_rot calc_test_pos_rot_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">mode</span><span class="token punctuation">(</span>mode<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">game_clk_rst</span><span class="token punctuation">(</span>game_clk_rst<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">game_clk</span><span class="token punctuation">(</span>game_clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_left_en</span><span class="token punctuation">(</span>btn_left_en<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_right_en</span><span class="token punctuation">(</span>btn_right_en<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_rotate_en</span><span class="token punctuation">(</span>btn_rotate_en<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_down_en</span><span class="token punctuation">(</span>btn_down_en<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_drop_en</span><span class="token punctuation">(</span>btn_drop_en<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_pos_x</span><span class="token punctuation">(</span>cur_pos_x<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_pos_y</span><span class="token punctuation">(</span>cur_pos_y<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">cur_rot</span><span class="token punctuation">(</span>cur_rot<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">test_pos_x</span><span class="token punctuation">(</span>test_pos_x<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">test_pos_y</span><span class="token punctuation">(</span>test_pos_y<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">test_rot</span><span class="token punctuation">(</span>test_rot<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Set up the outputs for the calc_test_blk module</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_blk_1<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_blk_2<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_blk_3<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_blk_4<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_SIZE</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_width<span class="token punctuation">;</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_SIZE</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> test_height<span class="token punctuation">;</span>    calc_cur_blk calc_test_block_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">piece</span><span class="token punctuation">(</span>cur_piece<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">pos_x</span><span class="token punctuation">(</span>test_pos_x<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">pos_y</span><span class="token punctuation">(</span>test_pos_y<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">rot</span><span class="token punctuation">(</span>test_rot<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_1</span><span class="token punctuation">(</span>test_blk_1<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_2</span><span class="token punctuation">(</span>test_blk_2<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_3</span><span class="token punctuation">(</span>test_blk_3<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">blk_4</span><span class="token punctuation">(</span>test_blk_4<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">width</span><span class="token punctuation">(</span>test_width<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">height</span><span class="token punctuation">(</span>test_height<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// This function checks whether its input block positions intersect</span>    <span class="token comment" spellcheck="true">// with any fallen pieces.</span>    <span class="token keyword">function</span> intersects_fallen_pieces<span class="token punctuation">;</span>        <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk1<span class="token punctuation">;</span>        <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk2<span class="token punctuation">;</span>        <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk3<span class="token punctuation">;</span>        <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> blk4<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            intersects_fallen_pieces <span class="token operator">=</span> fallen_pieces<span class="token punctuation">[</span>blk1<span class="token punctuation">]</span> <span class="token operator">||</span>                                       fallen_pieces<span class="token punctuation">[</span>blk2<span class="token punctuation">]</span> <span class="token operator">||</span>                                       fallen_pieces<span class="token punctuation">[</span>blk3<span class="token punctuation">]</span> <span class="token operator">||</span>                                       fallen_pieces<span class="token punctuation">[</span>blk4<span class="token punctuation">]</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">endfunction</span>    <span class="token comment" spellcheck="true">// This signal goes high when the test positions/rotations intersect with</span>    <span class="token comment" spellcheck="true">// fallen blocks.</span>    <span class="token keyword">wire</span> test_intersects <span class="token operator">=</span> <span class="token function">intersects_fallen_pieces</span><span class="token punctuation">(</span>test_blk_1<span class="token punctuation">,</span> test_blk_2<span class="token punctuation">,</span> test_blk_3<span class="token punctuation">,</span> test_blk_4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// If the falling piece can be moved left, moves it left</span>    <span class="token keyword">task</span> move_left<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_pos_x <span class="token operator">></span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>test_intersects<span class="token punctuation">)</span> <span class="token keyword">begin</span>                cur_pos_x <span class="token operator">&lt;=</span> cur_pos_x <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// If the falling piece can be moved right, moves it right</span>    <span class="token keyword">task</span> move_right<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_pos_x <span class="token operator">+</span> cur_width <span class="token operator">&lt;</span> <span class="token constant">`BLOCKS_WIDE</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>test_intersects<span class="token punctuation">)</span> <span class="token keyword">begin</span>                cur_pos_x <span class="token operator">&lt;=</span> cur_pos_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// Rotates the current block if it would not cause any part of the</span>    <span class="token comment" spellcheck="true">// block to go off screen and would not intersect with any fallen blocks.</span>    <span class="token keyword">task</span> rotate<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_pos_x <span class="token operator">+</span> test_width <span class="token operator">&lt;=</span> <span class="token constant">`BLOCKS_WIDE</span> <span class="token operator">&amp;&amp;</span>                cur_pos_y <span class="token operator">+</span> test_height <span class="token operator">&lt;=</span> <span class="token constant">`BLOCKS_HIGH</span> <span class="token operator">&amp;&amp;</span>                <span class="token operator">!</span>test_intersects<span class="token punctuation">)</span> <span class="token keyword">begin</span>                cur_rot <span class="token operator">&lt;=</span> cur_rot <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// Adds the current block to fallen_pieces</span>    <span class="token keyword">task</span> add_to_fallen_pieces<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            fallen_pieces<span class="token punctuation">[</span>cur_blk_1<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>            fallen_pieces<span class="token punctuation">[</span>cur_blk_2<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>            fallen_pieces<span class="token punctuation">[</span>cur_blk_3<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>            fallen_pieces<span class="token punctuation">[</span>cur_blk_4<span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// Adds the given blocks to fallen_pieces, and</span>    <span class="token comment" spellcheck="true">// chooses a new block for the user that appears</span>    <span class="token comment" spellcheck="true">// at the top of the screen.</span>    <span class="token keyword">task</span> get_new_block<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// Reset the drop timer, can't drop until this is high enough</span>            drop_timer <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Choose a new block for the user</span>            cur_piece <span class="token operator">&lt;=</span> random_piece<span class="token punctuation">;</span>            cur_pos_x <span class="token operator">&lt;=</span> <span class="token punctuation">(</span><span class="token constant">`BLOCKS_WIDE</span> <span class="token operator">/</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            cur_pos_y <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            cur_rot <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// reset the game timer so the user has a full</span>            <span class="token comment" spellcheck="true">// cycle before the block falls</span>            game_clk_rst <span class="token operator">&lt;=</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// Moves the current piece down one, getting a new block if</span>    <span class="token comment" spellcheck="true">// the piece would go off the board or intersect with another block.</span>    <span class="token keyword">task</span> move_down<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_pos_y <span class="token operator">+</span> cur_height <span class="token operator">&lt;</span> <span class="token constant">`BLOCKS_HIGH</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>test_intersects<span class="token punctuation">)</span> <span class="token keyword">begin</span>                cur_pos_y <span class="token operator">&lt;=</span> cur_pos_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                <span class="token function">add_to_fallen_pieces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>                <span class="token function">get_new_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// Sets the mode to MODE_DROP, in which the current block will not respond</span>    <span class="token comment" spellcheck="true">// to user input and it will move down at one cycle per second until it hits</span>    <span class="token comment" spellcheck="true">// a block or the bottom of the board.</span>    <span class="token keyword">task</span> drop_to_bottom<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            mode <span class="token operator">&lt;=</span> <span class="token constant">`MODE_DROP</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// The score register, increased by one when the user</span>    <span class="token comment" spellcheck="true">// completes a row.</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_1<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1's place</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_2<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 10's place</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_3<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 100's place</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> score_4<span class="token punctuation">;</span> <span class="token comment" spellcheck="true">// 1000's place</span>    <span class="token comment" spellcheck="true">// The 7-segment display module, which outputs the score</span>    seg_display score_display_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">score_1</span><span class="token punctuation">(</span>score_1<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">score_2</span><span class="token punctuation">(</span>score_2<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">score_3</span><span class="token punctuation">(</span>score_3<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">score_4</span><span class="token punctuation">(</span>score_4<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">an</span><span class="token punctuation">(</span>an<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">seg</span><span class="token punctuation">(</span>seg<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// The module that determines which row, if any, is complete</span>    <span class="token comment" spellcheck="true">// and needs to be removed and the score incremented</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_Y_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> remove_row_y<span class="token punctuation">;</span>    <span class="token keyword">wire</span> remove_row_en<span class="token punctuation">;</span>    complete_row complete_row_ <span class="token punctuation">(</span>        <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">pause</span><span class="token punctuation">(</span>mode <span class="token operator">!=</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">fallen_pieces</span><span class="token punctuation">(</span>fallen_pieces<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">row</span><span class="token punctuation">(</span>remove_row_y<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">enabled</span><span class="token punctuation">(</span>remove_row_en<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// This task removes the completed row from fallen_pieces</span>    <span class="token comment" spellcheck="true">// and increments the score</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token constant">`BITS_Y_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> shifting_row<span class="token punctuation">;</span>    <span class="token keyword">task</span> remove_row<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// Shift away remove_row_y</span>            mode <span class="token operator">&lt;=</span> <span class="token constant">`MODE_SHIFT</span><span class="token punctuation">;</span>            shifting_row <span class="token operator">&lt;=</span> remove_row_y<span class="token punctuation">;</span>            <span class="token comment" spellcheck="true">// Increment the score</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>score_1 <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>score_2 <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                    <span class="token keyword">if</span> <span class="token punctuation">(</span>score_3 <span class="token operator">==</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                        <span class="token keyword">if</span> <span class="token punctuation">(</span>score_4 <span class="token operator">!=</span> <span class="token number">9</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                            score_4 <span class="token operator">&lt;=</span> score_4 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                            score_3 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            score_2 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                            score_1 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                        <span class="token keyword">end</span>                    <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                        score_3 <span class="token operator">&lt;=</span> score_3 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                        score_2 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                        score_1 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>                <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                    score_2 <span class="token operator">&lt;=</span> score_2 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>                    score_1 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                <span class="token keyword">end</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                score_1 <span class="token operator">&lt;=</span> score_1 <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// Initialize any registers we need</span>    <span class="token keyword">initial</span> <span class="token keyword">begin</span>        mode <span class="token operator">=</span> <span class="token constant">`MODE_IDLE</span><span class="token punctuation">;</span>        fallen_pieces <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        cur_piece <span class="token operator">=</span> <span class="token constant">`EMPTY_BLOCK</span><span class="token punctuation">;</span>        cur_pos_x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        cur_pos_y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        cur_rot <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        score_1 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        score_2 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        score_3 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>        score_4 <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token comment" spellcheck="true">// Starts a new game after a button is pressed in the MODE_IDLE state</span>    <span class="token keyword">task</span> start_game<span class="token punctuation">;</span>        <span class="token keyword">begin</span>            mode <span class="token operator">&lt;=</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">;</span>            fallen_pieces <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            score_1 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            score_2 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            score_3 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            score_4 <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>            <span class="token function">get_new_block</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">endtask</span>    <span class="token comment" spellcheck="true">// Determine if the game is over because the current position</span>    <span class="token comment" spellcheck="true">// intersects with a fallen block</span>    <span class="token keyword">wire</span> game_over <span class="token operator">=</span> cur_pos_y <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> <span class="token function">intersects_fallen_pieces</span><span class="token punctuation">(</span>cur_blk_1<span class="token punctuation">,</span> cur_blk_2<span class="token punctuation">,</span> cur_blk_3<span class="token punctuation">,</span> cur_blk_4<span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Main game logic</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>drop_timer <span class="token operator">&lt;</span> <span class="token constant">`DROP_TIMER_MAX</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            drop_timer <span class="token operator">&lt;=</span> drop_timer <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>        game_clk_rst <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">`MODE_IDLE</span> <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>sw_rst_en <span class="token operator">||</span> sw_rst_dis<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// We are in idle mode and the user has requested to start the game</span>            <span class="token function">start_game</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>sw_rst_en <span class="token operator">||</span> sw_rst_dis <span class="token operator">||</span> game_over<span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// We hit the reset switch or the game ended by itself,</span>            <span class="token comment" spellcheck="true">// go into idle mode where we wait for the user to press a button</span>            mode <span class="token operator">&lt;=</span> <span class="token constant">`MODE_IDLE</span><span class="token punctuation">;</span>            <span class="token function">add_to_fallen_pieces</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            cur_piece <span class="token operator">&lt;=</span> <span class="token constant">`EMPTY_BLOCK</span><span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sw_pause_en <span class="token operator">||</span> sw_pause_dis<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mode <span class="token operator">==</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// If we switch on pause, save the old mode and enter</span>            <span class="token comment" spellcheck="true">// the pause mode.</span>            mode <span class="token operator">&lt;=</span> <span class="token constant">`MODE_PAUSE</span><span class="token punctuation">;</span>            old_mode <span class="token operator">&lt;=</span> mode<span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>sw_pause_en <span class="token operator">||</span> sw_pause_dis<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> mode <span class="token operator">==</span> <span class="token constant">`MODE_PAUSE</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// If we switch off pause, enter the old mode</span>            mode <span class="token operator">&lt;=</span> old_mode<span class="token punctuation">;</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// Normal gameplay</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>game_clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token function">move_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_left_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token function">move_left</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_right_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token function">move_right</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_rotate_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token function">rotate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_down_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token function">move_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>btn_drop_en <span class="token operator">&amp;&amp;</span> drop_timer <span class="token operator">==</span> <span class="token constant">`DROP_TIMER_MAX</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token function">drop_to_bottom</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>remove_row_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token function">remove_row</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">`MODE_DROP</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// We are dropping the block until we hit respawn</span>            <span class="token comment" spellcheck="true">// at the top</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>game_clk_rst <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>sw_pause_en<span class="token punctuation">)</span> <span class="token keyword">begin</span>                mode <span class="token operator">&lt;=</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                <span class="token function">move_down</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>mode <span class="token operator">==</span> <span class="token constant">`MODE_SHIFT</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// We are shifting the row above shifting_row</span>            <span class="token comment" spellcheck="true">// into shifting_row's position</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>shifting_row <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                fallen_pieces<span class="token punctuation">[</span><span class="token number">0</span> <span class="token operator">+</span><span class="token punctuation">:</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>                mode <span class="token operator">&lt;=</span> <span class="token constant">`MODE_PLAY</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                fallen_pieces<span class="token punctuation">[</span>shifting_row<span class="token operator">*</span><span class="token constant">`BLOCKS_WIDE</span> <span class="token operator">+</span><span class="token punctuation">:</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> fallen_pieces<span class="token punctuation">[</span><span class="token punctuation">(</span>shifting_row <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token constant">`BLOCKS_WIDE</span> <span class="token operator">+</span><span class="token punctuation">:</span> <span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>                shifting_row <span class="token operator">&lt;=</span> shifting_row <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre><h2 id="vga-display-v"><a href="#vga-display-v" class="headerlink" title="vga_display.v"></a>vga_display.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`include</span> <span class="token string">"definitions.vh"</span><span class="token keyword">module</span> <span class="token function">vga_display</span><span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span>                                   clk<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_PER_BLOCK</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>             cur_piece<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>               cur_blk_1<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>               cur_blk_2<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>               cur_blk_3<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token constant">`BITS_BLK_POS</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>               cur_blk_4<span class="token punctuation">,</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token punctuation">(</span><span class="token constant">`BLOCKS_WIDE</span><span class="token operator">*</span><span class="token constant">`BLOCKS_HIGH</span><span class="token punctuation">)</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> fallen_pieces<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>                             rgb<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>                                  hsync<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>                                  vsync    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> counter_x <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> counter_y <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">assign</span> hsync <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>counter_x <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token constant">`PIXEL_WIDTH</span> <span class="token operator">+</span> <span class="token constant">`HSYNC_FRONT_PORCH</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                     counter_x <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token constant">`PIXEL_WIDTH</span> <span class="token operator">+</span> <span class="token constant">`HSYNC_FRONT_PORCH</span> <span class="token operator">+</span> <span class="token constant">`HSYNC_PULSE_WIDTH</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">assign</span> vsync <span class="token operator">=</span> <span class="token operator">~</span><span class="token punctuation">(</span>counter_y <span class="token operator">>=</span> <span class="token punctuation">(</span><span class="token constant">`PIXEL_HEIGHT</span> <span class="token operator">+</span> <span class="token constant">`VSYNC_FRONT_PORCH</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>                     counter_y <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token constant">`PIXEL_HEIGHT</span> <span class="token operator">+</span> <span class="token constant">`VSYNC_FRONT_PORCH</span> <span class="token operator">+</span> <span class="token constant">`VSYNC_PULSE_WIDTH</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">// Combinational logic to select the current pixel</span>    <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_blk_index <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>counter_x<span class="token operator">-</span><span class="token constant">`BOARD_X</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token constant">`BLOCK_SIZE</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">(</span>counter_y<span class="token operator">-</span><span class="token constant">`BOARD_Y</span><span class="token punctuation">)</span><span class="token operator">/</span><span class="token constant">`BLOCK_SIZE</span><span class="token punctuation">)</span><span class="token operator">*</span><span class="token constant">`BLOCKS_WIDE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> cur_vid_mem<span class="token punctuation">;</span>    <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>        <span class="token comment" spellcheck="true">// Check if we're within the drawing space</span>        <span class="token keyword">if</span> <span class="token punctuation">(</span>counter_x <span class="token operator">>=</span> <span class="token constant">`BOARD_X</span> <span class="token operator">&amp;&amp;</span> counter_y <span class="token operator">>=</span> <span class="token constant">`BOARD_Y</span> <span class="token operator">&amp;&amp;</span>            counter_x <span class="token operator">&lt;=</span> <span class="token constant">`BOARD_X</span> <span class="token operator">+</span> <span class="token constant">`BOARD_WIDTH</span> <span class="token operator">&amp;&amp;</span> counter_y <span class="token operator">&lt;=</span> <span class="token constant">`BOARD_Y</span> <span class="token operator">+</span> <span class="token constant">`BOARD_HEIGHT</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>            <span class="token keyword">if</span> <span class="token punctuation">(</span>counter_x <span class="token operator">==</span> <span class="token constant">`BOARD_X</span> <span class="token operator">||</span> counter_x <span class="token operator">==</span> <span class="token constant">`BOARD_X</span> <span class="token operator">+</span> <span class="token constant">`BOARD_WIDTH</span> <span class="token operator">||</span>                counter_y <span class="token operator">==</span> <span class="token constant">`BOARD_Y</span> <span class="token operator">||</span> counter_y <span class="token operator">==</span> <span class="token constant">`BOARD_Y</span> <span class="token operator">+</span> <span class="token constant">`BOARD_HEIGHT</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>                <span class="token comment" spellcheck="true">// We're at the edge of the board, paint it white</span>                rgb <span class="token operator">=</span> <span class="token constant">`WHITE</span><span class="token punctuation">;</span>            <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                <span class="token keyword">if</span> <span class="token punctuation">(</span>cur_blk_index <span class="token operator">==</span> cur_blk_1 <span class="token operator">||</span>                    cur_blk_index <span class="token operator">==</span> cur_blk_2 <span class="token operator">||</span>                    cur_blk_index <span class="token operator">==</span> cur_blk_3 <span class="token operator">||</span>                    cur_blk_index <span class="token operator">==</span> cur_blk_4<span class="token punctuation">)</span> <span class="token keyword">begin</span>                    <span class="token keyword">case</span> <span class="token punctuation">(</span>cur_piece<span class="token punctuation">)</span>                        <span class="token constant">`EMPTY_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`GRAY</span><span class="token punctuation">;</span>                        <span class="token constant">`I_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`CYAN</span><span class="token punctuation">;</span>                        <span class="token constant">`O_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`YELLOW</span><span class="token punctuation">;</span>                        <span class="token constant">`T_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`PURPLE</span><span class="token punctuation">;</span>                        <span class="token constant">`S_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`GREEN</span><span class="token punctuation">;</span>                        <span class="token constant">`Z_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`RED</span><span class="token punctuation">;</span>                        <span class="token constant">`J_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`BLUE</span><span class="token punctuation">;</span>                        <span class="token constant">`L_BLOCK</span><span class="token punctuation">:</span> rgb <span class="token operator">=</span> <span class="token constant">`ORANGE</span><span class="token punctuation">;</span>                    <span class="token keyword">endcase</span>                <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>                    rgb <span class="token operator">=</span> fallen_pieces<span class="token punctuation">[</span>cur_blk_index<span class="token punctuation">]</span> <span class="token operator">?</span> <span class="token constant">`WHITE</span> <span class="token punctuation">:</span> <span class="token constant">`GRAY</span><span class="token punctuation">;</span>                <span class="token keyword">end</span>            <span class="token keyword">end</span>        <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>            <span class="token comment" spellcheck="true">// Outside the board</span>            rgb <span class="token operator">=</span> <span class="token constant">`BLACK</span><span class="token punctuation">;</span>        <span class="token keyword">end</span>    <span class="token keyword">end</span>   <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span> <span class="token keyword">begin</span>       <span class="token keyword">if</span> <span class="token punctuation">(</span>counter_x <span class="token operator">>=</span> <span class="token constant">`PIXEL_WIDTH</span> <span class="token operator">+</span> <span class="token constant">`HSYNC_FRONT_PORCH</span> <span class="token operator">+</span> <span class="token constant">`HSYNC_PULSE_WIDTH</span> <span class="token operator">+</span> <span class="token constant">`HSYNC_BACK_PORCH</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>           counter_x <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token keyword">if</span> <span class="token punctuation">(</span>counter_y <span class="token operator">>=</span> <span class="token constant">`PIXEL_HEIGHT</span> <span class="token operator">+</span> <span class="token constant">`VSYNC_FRONT_PORCH</span> <span class="token operator">+</span> <span class="token constant">`VSYNC_PULSE_WIDTH</span> <span class="token operator">+</span> <span class="token constant">`VSYNC_BACK_PORCH</span><span class="token punctuation">)</span> <span class="token keyword">begin</span>               counter_y <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">;</span>           <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>               counter_y <span class="token operator">&lt;=</span> counter_y <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>           <span class="token keyword">end</span>       <span class="token keyword">end</span> <span class="token keyword">else</span> <span class="token keyword">begin</span>           counter_x <span class="token operator">&lt;=</span> counter_x <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">;</span>       <span class="token keyword">end</span>   <span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre><p>为了能够用键盘进行游戏，需要编写按键的控制代码，这里为了简单，用了ps2键盘实现</p><h2 id="ps2scan-v"><a href="#ps2scan-v" class="headerlink" title="ps2scan.v"></a>ps2scan.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`timescale</span> <span class="token number">1</span>ns <span class="token operator">/</span> <span class="token number">1</span>ps<span class="token keyword">module</span> ps2scan <span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> clk<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> rst_n<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> ps2_sclk<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> ps2_sda<span class="token punctuation">,</span>     <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> out_data    <span class="token punctuation">)</span><span class="token punctuation">;</span>      <span class="token comment" spellcheck="true">//端口信号：模块的输入输出接口</span>    <span class="token comment" spellcheck="true">//input clk;//系统时钟</span>    <span class="token comment" spellcheck="true">//input rst_n;//低电平复位</span>    <span class="token comment" spellcheck="true">//input    ps2_sclk;//ps2时钟信号（ps2设备自动产生，大约10KHz左右）</span>    <span class="token comment" spellcheck="true">//input ps2_sda;//ps2数据信号</span>    <span class="token comment" spellcheck="true">//output reg [7:0] out_data; //键值数据（采集ps2的一帧信号中间的8位有效位）</span>    <span class="token comment" spellcheck="true">//在发送时序中，数据在ps2_sclk的下降沿采集信号，以下为检测下降沿</span>    <span class="token keyword">reg</span>  in1<span class="token punctuation">,</span>in2<span class="token punctuation">;</span>        <span class="token keyword">wire</span> en<span class="token punctuation">;</span>        <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk <span class="token keyword">or</span> <span class="token keyword">negedge</span> rst_n<span class="token punctuation">)</span>    <span class="token keyword">begin</span>        <span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>             <span class="token keyword">begin</span>                in1 <span class="token operator">&lt;=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>                in2 <span class="token operator">&lt;=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">else</span>             <span class="token keyword">begin</span>                                                in1 <span class="token operator">&lt;=</span> ps2_sclk<span class="token punctuation">;</span>                in2 <span class="token operator">&lt;=</span> in1<span class="token punctuation">;</span>            <span class="token keyword">end</span>    <span class="token keyword">end</span>    <span class="token keyword">assign</span> en <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token operator">~</span>in1<span class="token punctuation">)</span> <span class="token operator">&amp;</span> in2<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//当出现ps2_sclk下降沿后拉高一个时钟，以进行数据的采集</span>    <span class="token comment" spellcheck="true">//采集ps2的一帧信号中间的8位有效位:每检测一个下降沿算一位数据位，在中间8位采集有效数据</span>    <span class="token keyword">reg</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> temp_data<span class="token punctuation">;</span>                <span class="token keyword">reg</span><span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> num<span class="token punctuation">;</span>        <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk <span class="token keyword">or</span> <span class="token keyword">negedge</span> rst_n<span class="token punctuation">)</span>    <span class="token keyword">begin</span>        <span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>             <span class="token keyword">begin</span>                num <span class="token operator">&lt;=</span> <span class="token number">4'd0</span><span class="token punctuation">;</span>                temp_data <span class="token operator">&lt;=</span> <span class="token number">8'd0</span><span class="token punctuation">;</span>            <span class="token keyword">end</span>        <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>en<span class="token punctuation">)</span>             <span class="token keyword">case</span> <span class="token punctuation">(</span>num<span class="token punctuation">)</span>                <span class="token number">4'd0</span><span class="token punctuation">:</span>    num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//开始位</span>                <span class="token number">4'd1</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit0</span>                        <span class="token keyword">end</span>                <span class="token number">4'd2</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit1</span>                        <span class="token keyword">end</span>                <span class="token number">4'd3</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit2</span>                        <span class="token keyword">end</span>                <span class="token number">4'd4</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit3</span>                        <span class="token keyword">end</span>                <span class="token number">4'd5</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit4</span>                        <span class="token keyword">end</span>                <span class="token number">4'd6</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">5</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit5</span>                        <span class="token keyword">end</span>                <span class="token number">4'd7</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit6</span>                        <span class="token keyword">end</span>                <span class="token number">4'd8</span><span class="token punctuation">:</span>    <span class="token keyword">begin</span>                            num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>                            temp_data<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">]</span> <span class="token operator">&lt;=</span> ps2_sda<span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//bit7</span>                        <span class="token keyword">end</span>                <span class="token number">4'd9</span><span class="token punctuation">:</span>    num <span class="token operator">&lt;=</span> num<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//结束位</span>                <span class="token number">4'd10</span><span class="token punctuation">:</span>  num <span class="token operator">&lt;=</span> <span class="token number">4'd0</span><span class="token punctuation">;</span>                    <span class="token keyword">default</span><span class="token punctuation">:</span> num<span class="token operator">&lt;=</span><span class="token number">4'd0</span><span class="token punctuation">;</span>            <span class="token keyword">endcase</span>        <span class="token keyword">end</span>    <span class="token comment" spellcheck="true">//判断是否有键按下：根据通码、断码的特性判断</span>    <span class="token keyword">reg</span> key<span class="token punctuation">;</span>        <span class="token important">always @</span> <span class="token punctuation">(</span><span class="token keyword">posedge</span> clk <span class="token keyword">or</span> <span class="token keyword">negedge</span> rst_n<span class="token punctuation">)</span>    <span class="token keyword">begin</span>        <span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>            key <span class="token operator">&lt;=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>        <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>num<span class="token operator">==</span><span class="token number">4'd10</span><span class="token punctuation">)</span>            <span class="token keyword">begin</span>                    <span class="token function">if</span><span class="token punctuation">(</span>temp_data <span class="token operator">==</span> <span class="token number">8'hf0</span><span class="token punctuation">)</span>                         key <span class="token operator">&lt;=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>                <span class="token keyword">else</span>                     <span class="token keyword">begin</span>                        <span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>key<span class="token punctuation">)</span>                             out_data <span class="token operator">&lt;=</span> temp_data<span class="token punctuation">;</span>                          <span class="token keyword">else</span>                             key <span class="token operator">&lt;=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>                    <span class="token keyword">end</span>            <span class="token keyword">end</span>    <span class="token keyword">end</span> <span class="token keyword">endmodule</span> </code></pre><h2 id="ps2-top-v"><a href="#ps2-top-v" class="headerlink" title="ps2_top.v"></a>ps2_top.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`timescale</span> <span class="token number">1</span>ns <span class="token operator">/</span> <span class="token number">1</span>ps<span class="token keyword">module</span> ps2_top <span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> clk<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> rst_n<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> ps2_sclk<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> ps2_sda<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> btn_drop<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> btn_rotate<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> btn_left<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> btn_right<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span> btn_down    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//外部接口</span>    <span class="token comment" spellcheck="true">//input clk;      //系统时钟50MHz</span>    <span class="token comment" spellcheck="true">//input rst_n;    //低电平复位</span>    <span class="token comment" spellcheck="true">//input ps2_sclk; //ps2时钟</span>    <span class="token comment" spellcheck="true">//input ps2_sda;  //ps2数据</span>    <span class="token comment" spellcheck="true">//output [2:0] sel;    //数码管位选</span>    <span class="token comment" spellcheck="true">//output [7:0] seg;     //数码管段选</span>    <span class="token keyword">wire</span><span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> out_data<span class="token punctuation">,</span> tx_out<span class="token punctuation">;</span>        <span class="token comment" spellcheck="true">/*****键盘扫描模块*****/</span>    ps2scan    <span class="token function">ps2scan_inst</span><span class="token punctuation">(</span>            <span class="token punctuation">.</span><span class="token function">clk</span><span class="token punctuation">(</span>clk<span class="token punctuation">)</span><span class="token punctuation">,</span>                         <span class="token punctuation">.</span><span class="token function">rst_n</span><span class="token punctuation">(</span>rst_n<span class="token punctuation">)</span><span class="token punctuation">,</span>                        <span class="token punctuation">.</span><span class="token function">ps2_sclk</span><span class="token punctuation">(</span>ps2_sclk<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">ps2_sda</span><span class="token punctuation">(</span>ps2_sda<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">out_data</span><span class="token punctuation">(</span>out_data<span class="token punctuation">)</span>    <span class="token punctuation">)</span><span class="token punctuation">;</span>    ASCII  <span class="token function">ASCII_inst</span><span class="token punctuation">(</span>               <span class="token punctuation">.</span><span class="token function">out_data</span><span class="token punctuation">(</span>out_data<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">tx_out</span><span class="token punctuation">(</span>tx_out<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_drop_wire</span><span class="token punctuation">(</span>btn_drop<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_rotate_wire</span><span class="token punctuation">(</span>btn_rotate<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_left_wire</span><span class="token punctuation">(</span>btn_left<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_right_wire</span><span class="token punctuation">(</span>btn_right<span class="token punctuation">)</span><span class="token punctuation">,</span>        <span class="token punctuation">.</span><span class="token function">btn_down_wire</span><span class="token punctuation">(</span>btn_down<span class="token punctuation">)</span>        <span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment" spellcheck="true">/*        seg_num  seg_num_inst(         .num(tx_out),        .clk(clk),        .rst_n(rst_n),        .sel(sel),        .seg(seg)     );    */</span>    <span class="token keyword">endmodule</span> </code></pre><h2 id="ASCII-v"><a href="#ASCII-v" class="headerlink" title="ASCII.v"></a>ASCII.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`timescale</span> <span class="token number">1</span>ns <span class="token operator">/</span> <span class="token number">1</span>ps<span class="token keyword">module</span> <span class="token function">ASCII</span><span class="token punctuation">(</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> out_data<span class="token punctuation">,</span>     <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> tx_out<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>      btn_drop_wire<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>      btn_rotate_wire<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>      btn_left_wire<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>      btn_right_wire<span class="token punctuation">,</span>    <span class="token keyword">output</span> <span class="token keyword">wire</span>      btn_down_wire    <span class="token punctuation">)</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//?????????????é??????????????</span>    <span class="token comment" spellcheck="true">//input [7:0] out_data;   //?ü?????¨?è?ü??</span>    <span class="token comment" spellcheck="true">//output reg [7:0] tx_out;//?¨??ASCII??×??????ó????</span>    <span class="token comment" spellcheck="true">//?¨???é??±í??·?????????ASCII?????ü??×???????????????</span>    <span class="token important">always@</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>         <span class="token keyword">case</span> <span class="token punctuation">(</span>out_data<span class="token punctuation">)</span>                    <span class="token number">8'h1c</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h41</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//A</span>            <span class="token number">8'h32</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h42</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//B</span>            <span class="token number">8'h21</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h43</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//C</span>            <span class="token number">8'h23</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h44</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//D</span>            <span class="token number">8'h24</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h45</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//E</span>            <span class="token number">8'h2b</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h46</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//F</span>            <span class="token number">8'h34</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h47</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//G</span>            <span class="token number">8'h33</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h48</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//H</span>            <span class="token number">8'h43</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h49</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//I</span>            <span class="token number">8'h3b</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h4a</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//J</span>            <span class="token number">8'h42</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h4b</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//K</span>            <span class="token number">8'h4b</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h4c</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//L</span>            <span class="token number">8'h3a</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h4d</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//M</span>            <span class="token number">8'h31</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h4e</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//N    </span>            <span class="token number">8'h44</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h4f</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//O</span>            <span class="token number">8'h4d</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h50</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//P</span>            <span class="token number">8'h15</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h51</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//Q</span>            <span class="token number">8'h2d</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h52</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//R</span>            <span class="token number">8'h1b</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h53</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//S</span>            <span class="token number">8'h2c</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h54</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//T</span>            <span class="token number">8'h3c</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h55</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//U</span>            <span class="token number">8'h2a</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h56</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//V</span>            <span class="token number">8'h1d</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h57</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//W</span>            <span class="token number">8'h22</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h58</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//X</span>            <span class="token number">8'h35</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h59</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//Y</span>            <span class="token number">8'h1a</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h5a</span><span class="token punctuation">;</span>    <span class="token comment" spellcheck="true">//Z</span>            <span class="token keyword">default</span><span class="token punctuation">:</span> tx_out <span class="token operator">&lt;=</span> <span class="token number">8'h00</span><span class="token punctuation">;</span>        <span class="token keyword">endcase</span>    <span class="token keyword">reg</span>      btn_drop<span class="token punctuation">;</span>    <span class="token keyword">reg</span>      btn_rotate<span class="token punctuation">;</span>    <span class="token keyword">reg</span>      btn_left<span class="token punctuation">;</span>    <span class="token keyword">reg</span>      btn_right<span class="token punctuation">;</span>    <span class="token keyword">reg</span>      btn_down<span class="token punctuation">;</span>    <span class="token keyword">assign</span> btn_drop_wire <span class="token operator">=</span> btn_drop<span class="token punctuation">;</span>    <span class="token keyword">assign</span> btn_rotate_wire <span class="token operator">=</span>  btn_rotate<span class="token punctuation">;</span>    <span class="token keyword">assign</span> btn_left_wire <span class="token operator">=</span>  btn_left<span class="token punctuation">;</span>    <span class="token keyword">assign</span> btn_right_wire <span class="token operator">=</span>  btn_right<span class="token punctuation">;</span>    <span class="token keyword">assign</span> btn_down_wire <span class="token operator">=</span>  btn_down<span class="token punctuation">;</span>    <span class="token important">always @</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">)</span>    <span class="token keyword">begin</span>    <span class="token function">if</span><span class="token punctuation">(</span>out_data<span class="token operator">==</span><span class="token number">8'h1d</span><span class="token punctuation">)</span>         <span class="token keyword">begin</span>    btn_drop <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_rotate <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>    btn_left <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_right <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_down <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>out_data<span class="token operator">==</span><span class="token number">8'h1c</span><span class="token punctuation">)</span>     <span class="token keyword">begin</span>    btn_drop <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_rotate <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_left <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>    btn_right <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_down <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>out_data<span class="token operator">==</span><span class="token number">8'h1b</span><span class="token punctuation">)</span>    <span class="token keyword">begin</span>    btn_drop <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_rotate <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_left <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_right <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_down <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>out_data<span class="token operator">==</span><span class="token number">8'h23</span><span class="token punctuation">)</span>    <span class="token keyword">begin</span>    btn_drop <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_rotate <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_left <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_right <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>    btn_down <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token keyword">else</span> <span class="token function">if</span><span class="token punctuation">(</span>out_data<span class="token operator">==</span><span class="token number">8'h2b</span><span class="token punctuation">)</span>    <span class="token keyword">begin</span>    btn_drop <span class="token operator">=</span> <span class="token number">1'b1</span><span class="token punctuation">;</span>    btn_rotate <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_left <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_right <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    btn_down <span class="token operator">=</span> <span class="token number">1'b0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span>    <span class="token keyword">end</span><span class="token keyword">endmodule</span> </code></pre><h2 id="seg-num-v"><a href="#seg-num-v" class="headerlink" title="seg_num.v"></a>seg_num.v</h2><pre class=" language-verilog"><code class="language-verilog"><span class="token constant">`timescale</span> <span class="token number">1</span>ns <span class="token operator">/</span> <span class="token number">1</span>ps<span class="token keyword">module</span> seg_num <span class="token punctuation">(</span>    <span class="token keyword">input</span> <span class="token keyword">wire</span> clk<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> rst_n<span class="token punctuation">,</span>     <span class="token keyword">input</span> <span class="token keyword">wire</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> num<span class="token punctuation">,</span>     <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> sel<span class="token punctuation">,</span>     <span class="token keyword">output</span> <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span> seg    <span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token keyword">reg</span> <span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span>number<span class="token operator">=</span><span class="token number">17'd0</span><span class="token punctuation">;</span>   <span class="token important">always@</span><span class="token punctuation">(</span><span class="token keyword">posedge</span> clk <span class="token keyword">or</span> <span class="token keyword">negedge</span> rst_n<span class="token punctuation">)</span><span class="token keyword">begin</span><span class="token function">if</span><span class="token punctuation">(</span><span class="token operator">!</span>rst_n<span class="token punctuation">)</span>    number<span class="token operator">&lt;=</span><span class="token number">17'd0</span><span class="token punctuation">;</span><span class="token keyword">else</span>    <span class="token keyword">begin</span>    <span class="token function">if</span><span class="token punctuation">(</span>number<span class="token operator">&lt;</span><span class="token number">40000</span><span class="token punctuation">)</span>    number<span class="token operator">&lt;=</span>number<span class="token operator">+</span><span class="token number">1'b1</span><span class="token punctuation">;</span>    <span class="token keyword">else</span>     number<span class="token operator">&lt;=</span><span class="token number">0</span><span class="token punctuation">;</span>    <span class="token keyword">end</span><span class="token keyword">end</span><span class="token important">always@</span><span class="token punctuation">(</span><span class="token keyword">posedge</span> clk<span class="token punctuation">)</span><span class="token keyword">begin</span>    <span class="token function">if</span><span class="token punctuation">(</span>number<span class="token operator">></span><span class="token number">20000</span><span class="token punctuation">)</span>    <span class="token keyword">begin</span>    sel<span class="token operator">=</span><span class="token number">4'b1101</span><span class="token punctuation">;</span>    <span class="token function">case</span><span class="token punctuation">(</span>num<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span>                <span class="token number">4'd0</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1100_0000</span><span class="token punctuation">;</span>                <span class="token number">4'd1</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1111_1001</span><span class="token punctuation">;</span>                <span class="token number">4'd2</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1010_0100</span><span class="token punctuation">;</span>                <span class="token number">4'd3</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1011_0000</span><span class="token punctuation">;</span>                <span class="token number">4'd4</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1001_1001</span><span class="token punctuation">;</span>                <span class="token number">4'd5</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1001_0010</span><span class="token punctuation">;</span>                <span class="token number">4'd6</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0010</span><span class="token punctuation">;</span>                <span class="token number">4'd7</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1111_1000</span><span class="token punctuation">;</span>                <span class="token number">4'd8</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0000</span><span class="token punctuation">;</span>                <span class="token number">4'd9</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1001_0000</span><span class="token punctuation">;</span>                <span class="token number">4'd10</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_1000</span><span class="token punctuation">;</span>                <span class="token number">4'd11</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0011</span><span class="token punctuation">;</span>                <span class="token number">4'd12</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1010_0111</span><span class="token punctuation">;</span>                <span class="token number">4'd13</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1010_0001</span><span class="token punctuation">;</span>                <span class="token number">4'd14</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0110</span><span class="token punctuation">;</span>                <span class="token number">4'd15</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_1110</span><span class="token punctuation">;</span>                <span class="token keyword">default</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1111_0111</span><span class="token punctuation">;</span>               <span class="token keyword">endcase</span>            <span class="token keyword">end</span>    <span class="token keyword">else</span>    <span class="token keyword">begin</span>    sel<span class="token operator">=</span><span class="token number">4'b1110</span><span class="token punctuation">;</span>    <span class="token function">case</span><span class="token punctuation">(</span>num<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token number">4'd0</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1100_0000</span><span class="token punctuation">;</span>        <span class="token number">4'd1</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1111_1001</span><span class="token punctuation">;</span>        <span class="token number">4'd2</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1010_0100</span><span class="token punctuation">;</span>        <span class="token number">4'd3</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1011_0000</span><span class="token punctuation">;</span>        <span class="token number">4'd4</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1001_1001</span><span class="token punctuation">;</span>        <span class="token number">4'd5</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1001_0010</span><span class="token punctuation">;</span>        <span class="token number">4'd6</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0010</span><span class="token punctuation">;</span>        <span class="token number">4'd7</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1111_1000</span><span class="token punctuation">;</span>        <span class="token number">4'd8</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0000</span><span class="token punctuation">;</span>        <span class="token number">4'd9</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1001_0000</span><span class="token punctuation">;</span>        <span class="token number">4'd10</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_1000</span><span class="token punctuation">;</span>        <span class="token number">4'd11</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0011</span><span class="token punctuation">;</span>        <span class="token number">4'd12</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1010_0111</span><span class="token punctuation">;</span>        <span class="token number">4'd13</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1010_0001</span><span class="token punctuation">;</span>        <span class="token number">4'd14</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_0110</span><span class="token punctuation">;</span>        <span class="token number">4'd15</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1000_1110</span><span class="token punctuation">;</span>        <span class="token keyword">default</span><span class="token punctuation">:</span>seg<span class="token punctuation">[</span><span class="token number">7</span><span class="token punctuation">:</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token operator">&lt;=</span><span class="token number">8'b1111_0111</span><span class="token punctuation">;</span>       <span class="token keyword">endcase</span>       <span class="token keyword">end</span><span class="token keyword">end</span><span class="token keyword">endmodule</span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> FPGA </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo报错page.tags.forEach is not a function</title>
      <link href="2021/09/07/hexo-bao-cuo-page-tags-foreach-is-not-a-function/"/>
      <url>2021/09/07/hexo-bao-cuo-page-tags-foreach-is-not-a-function/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><p>我拉了 master 分支，当执行 hexo g 命令时发现以下错误。</p><pre class=" language-js"><code class="language-js">ERROR E<span class="token punctuation">:</span>\blog\themes\hexo<span class="token operator">-</span>theme<span class="token operator">-</span>matery\layout\post<span class="token punctuation">.</span>ejs<span class="token punctuation">:</span><span class="token number">26</span>    <span class="token number">24</span><span class="token operator">|</span>    <span class="token number">25</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isTocEnable<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">26</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/post-detail-toc.ejs'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">27</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">28</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/post-detail.ejs'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">29</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>E<span class="token punctuation">:</span>\blog\themes\hexo<span class="token operator">-</span>theme<span class="token operator">-</span>matery\layout\_partial\post<span class="token operator">-</span>detail<span class="token operator">-</span>toc<span class="token punctuation">.</span>ejs<span class="token punctuation">:</span><span class="token number">90</span>    <span class="token number">88</span><span class="token operator">|</span> <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">></span>    <span class="token number">89</span><span class="token operator">|</span>     <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"main-content"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col s12 m12 l9"</span><span class="token operator">></span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">90</span><span class="token operator">|</span>         <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/post-detail.ejs'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">91</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token number">92</span><span class="token operator">|</span>     <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"toc-aside"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"expanded col l3 hide-on-med-and-down"</span><span class="token operator">></span>    <span class="token number">93</span><span class="token operator">|</span>         <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"toc-widget"</span><span class="token operator">></span>E<span class="token punctuation">:</span>\blog\themes\hexo<span class="token operator">-</span>theme<span class="token operator">-</span>matery\layout\_partial\post<span class="token operator">-</span>detail<span class="token punctuation">.</span>ejs<span class="token punctuation">:</span><span class="token number">9</span>    <span class="token number">7</span><span class="token operator">|</span>                     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span>tags <span class="token operator">&amp;&amp;</span> page<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">8</span><span class="token operator">|</span>                     <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"article-tag"</span><span class="token operator">></span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">9</span><span class="token operator">|</span>                         <span class="token operator">&lt;</span><span class="token operator">%</span> page<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">10</span><span class="token operator">|</span>                             <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"&lt;%- url_for(tag.path) %>"</span> target<span class="token operator">=</span><span class="token string">"_blank"</span><span class="token operator">></span>    <span class="token number">11</span><span class="token operator">|</span>                                 <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"chip bg-color"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">=</span> tag<span class="token punctuation">.</span>name <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>    <span class="token number">12</span><span class="token operator">|</span>                             <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>page<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>forEach is not a <span class="token keyword">function</span>TypeError<span class="token punctuation">:</span> E<span class="token punctuation">:</span>\blog\themes\hexo<span class="token operator">-</span>theme<span class="token operator">-</span>matery\layout\post<span class="token punctuation">.</span>ejs<span class="token punctuation">:</span><span class="token number">26</span>    <span class="token number">24</span><span class="token operator">|</span>    <span class="token number">25</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>isTocEnable<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">26</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/post-detail-toc.ejs'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">27</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token keyword">else</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">28</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/post-detail.ejs'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">29</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token operator">&amp;</span>#<span class="token number">125</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>E<span class="token punctuation">:</span>\blog\themes\hexo<span class="token operator">-</span>theme<span class="token operator">-</span>matery\layout\_partial\post<span class="token operator">-</span>detail<span class="token operator">-</span>toc<span class="token punctuation">.</span>ejs<span class="token punctuation">:</span><span class="token number">90</span>    <span class="token number">88</span><span class="token operator">|</span> <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"row"</span><span class="token operator">></span>    <span class="token number">89</span><span class="token operator">|</span>     <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"main-content"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"col s12 m12 l9"</span><span class="token operator">></span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">90</span><span class="token operator">|</span>         <span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">-</span> <span class="token function">partial</span><span class="token punctuation">(</span><span class="token string">'_partial/post-detail.ejs'</span><span class="token punctuation">)</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">91</span><span class="token operator">|</span>     <span class="token operator">&lt;</span><span class="token operator">/</span>div<span class="token operator">></span>    <span class="token number">92</span><span class="token operator">|</span>     <span class="token operator">&lt;</span>div id<span class="token operator">=</span><span class="token string">"toc-aside"</span> <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"expanded col l3 hide-on-med-and-down"</span><span class="token operator">></span>    <span class="token number">93</span><span class="token operator">|</span>         <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"toc-widget"</span><span class="token operator">></span>E<span class="token punctuation">:</span>\blog\themes\hexo<span class="token operator">-</span>theme<span class="token operator">-</span>matery\layout\_partial\post<span class="token operator">-</span>detail<span class="token punctuation">.</span>ejs<span class="token punctuation">:</span><span class="token number">9</span>    <span class="token number">7</span><span class="token operator">|</span>                     <span class="token operator">&lt;</span><span class="token operator">%</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>page<span class="token punctuation">.</span>tags <span class="token operator">&amp;&amp;</span> page<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">8</span><span class="token operator">|</span>                     <span class="token operator">&lt;</span>div <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"article-tag"</span><span class="token operator">></span> <span class="token operator">></span><span class="token operator">></span> <span class="token number">9</span><span class="token operator">|</span>                         <span class="token operator">&lt;</span><span class="token operator">%</span> page<span class="token punctuation">.</span>tags<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span>tag<span class="token punctuation">)</span> <span class="token operator">&amp;</span>#<span class="token number">123</span><span class="token punctuation">;</span> <span class="token operator">%</span><span class="token operator">></span>    <span class="token number">10</span><span class="token operator">|</span>                             <span class="token operator">&lt;</span>a href<span class="token operator">=</span><span class="token string">"&lt;%- url_for(tag.path) %>"</span> target<span class="token operator">=</span><span class="token string">"_blank"</span><span class="token operator">></span>    <span class="token number">11</span><span class="token operator">|</span>                                 <span class="token operator">&lt;</span>span <span class="token keyword">class</span><span class="token operator">=</span><span class="token string">"chip bg-color"</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">%</span><span class="token operator">=</span> tag<span class="token punctuation">.</span>name <span class="token operator">%</span><span class="token operator">></span><span class="token operator">&lt;</span><span class="token operator">/</span>span<span class="token operator">></span>    <span class="token number">12</span><span class="token operator">|</span>                             <span class="token operator">&lt;</span><span class="token operator">/</span>a<span class="token operator">></span>page<span class="token punctuation">.</span>tags<span class="token punctuation">.</span>forEach is not a <span class="token keyword">function</span>    at eval <span class="token punctuation">(</span>eval at compile <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\ejs\lib\ejs<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">618</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>anonymous<span class="token operator">></span><span class="token punctuation">:</span><span class="token number">14</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">)</span>    at returnedFn <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\ejs\lib\ejs<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">653</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">)</span>    at Theme<span class="token punctuation">.</span>_View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>_compiledSync<span class="token punctuation">.</span>locals <span class="token punctuation">[</span><span class="token keyword">as</span> _compiledSync<span class="token punctuation">]</span> <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\theme\view<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">119</span><span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">)</span>    at Theme<span class="token punctuation">.</span>_View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>renderSync <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\theme\view<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">)</span>    at Object<span class="token punctuation">.</span>partial <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\plugins\helper\partial<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">)</span>    at eval <span class="token punctuation">(</span>eval at compile <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\ejs\lib\ejs<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">618</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>anonymous<span class="token operator">></span><span class="token punctuation">:</span><span class="token number">13</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">)</span>    at returnedFn <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\ejs\lib\ejs<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">653</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">)</span>    at Theme<span class="token punctuation">.</span>_View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>_compiledSync<span class="token punctuation">.</span>locals <span class="token punctuation">[</span><span class="token keyword">as</span> _compiledSync<span class="token punctuation">]</span> <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\theme\view<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">119</span><span class="token punctuation">:</span><span class="token number">22</span><span class="token punctuation">)</span>    at Theme<span class="token punctuation">.</span>_View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>renderSync <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\theme\view<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">)</span>    at Object<span class="token punctuation">.</span>partial <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\plugins\helper\partial<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">34</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">)</span>    at eval <span class="token punctuation">(</span>eval at compile <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\ejs\lib\ejs<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">618</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span>anonymous<span class="token operator">></span><span class="token punctuation">:</span><span class="token number">46</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">)</span>    at returnedFn <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\ejs\lib\ejs<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">653</span><span class="token punctuation">:</span><span class="token number">17</span><span class="token punctuation">)</span>    at Theme<span class="token punctuation">.</span>_View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>_compiled<span class="token punctuation">.</span>locals <span class="token punctuation">[</span><span class="token keyword">as</span> _compiled<span class="token punctuation">]</span> <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\theme\view<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">123</span><span class="token punctuation">:</span><span class="token number">48</span><span class="token punctuation">)</span>    at Theme<span class="token punctuation">.</span>_View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>View<span class="token punctuation">.</span>render <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\theme\view<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">29</span><span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">)</span>    at E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\hexo\index<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">349</span><span class="token punctuation">:</span><span class="token number">21</span>    at tryCatcher <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\node_modules\bluebird\js\release\util<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token number">23</span><span class="token punctuation">)</span>    at E<span class="token punctuation">:</span>\blog\node_modules\hexo\node_modules\bluebird\js\release\method<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">15</span><span class="token punctuation">:</span><span class="token number">34</span>    at RouteStream<span class="token punctuation">.</span>_read <span class="token punctuation">(</span>E<span class="token punctuation">:</span>\blog\node_modules\hexo\lib\hexo\router<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">123</span><span class="token punctuation">:</span><span class="token number">3</span><span class="token punctuation">)</span>    at RouteStream<span class="token punctuation">.</span>Readable<span class="token punctuation">.</span>read <span class="token punctuation">(</span>_stream_readable<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">457</span><span class="token punctuation">:</span><span class="token number">10</span><span class="token punctuation">)</span>    at resume_ <span class="token punctuation">(</span>_stream_readable<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">933</span><span class="token punctuation">:</span><span class="token number">12</span><span class="token punctuation">)</span>    at process<span class="token punctuation">.</span>_tickCallback <span class="token punctuation">(</span>internal<span class="token operator">/</span>process<span class="token operator">/</span>next_tick<span class="token punctuation">.</span>js<span class="token punctuation">:</span><span class="token number">63</span><span class="token punctuation">:</span><span class="token number">19</span><span class="token punctuation">)</span></code></pre><p>##JerrySheh最后发现是 source 目录下， _post 目录之外的 page 文章不能有 tag 标签，去除后问题得到解决。也就是说_post目录之外存在的md文件中不能有tag标签，删除每篇文章中的tag标签即可。</p><pre class=" language-bash"><code class="language-bash">$ hexo gINFO  Validating configINFO  Start processingINFO  Files loaded <span class="token keyword">in</span> 589 msINFO  Generated: atom.xmlINFO  Generated: about/index.htmlINFO  Generated: categories/index.htmlINFO  Generated: tags/index.htmlINFO  Generated: musics/index.htmlINFO  Generated: archives/2021/09/index.htmlINFO  Generated: tags/bash/index.htmlINFO  Generated: friends/index.htmlINFO  Generated: tags/Virtuoso/index.htmlINFO  Generated: archives/2021/08/index.htmlINFO  Generated: tags/python/index.htmlINFO  Generated: tags/Matlab/index.htmlINFO  Generated: tags/python銆佹枃浠朵紶杈▒/index.htmlINFO  Generated: 404.htmlINFO  Generated: medias/avatar.jpgINFO  Generated: archives/index.htmlINFO  Generated: archives/2021/index.htmlINFO  Generated: 鎬庝箞鍐欏崥瀹▒.htmlINFO  Generated: hello-world.htmlINFO  Generated: 鏍戣帗娲▒3B鐧婚檰鏂瑰紡.htmlINFO  Generated: index.htmlINFO  Generated: css/prism-tomorrow.cssINFO  Generated: favicon_old.pngINFO  Generated: medias/avatar_old.jpgINFO  Generated: medias/icp.pngINFO  Generated: medias/logo_old.pngINFO  Generated: medias/logo1.jpgINFO  Generated: medias/reward_old/alipay.jpgINFO  Generated: medias/comment_bg.pngINFO  Generated: medias/reward_old/wechat.pngINFO  Generated: libs/twikoo/twikoo.all.min.js.LICENSE.txtINFO  Generated: libs/lightGallery/fonts/lg.eotINFO  Generated: libs/share/fonts/iconfont.eotINFO  Generated: medias/featureimages/13.jpgINFO  Generated: favicon.pngINFO  Generated: medias/logo.pngINFO  Generated: medias/featureimages/16.jpgINFO  Generated: medias/featureimages/22.jpgINFO  Generated: medias/featureimages/23.jpgINFO  Generated: libs/lightGallery/img/loading.gifINFO  Generated: js/matery.jsINFO  Generated: libs/aos/aos.jsINFO  Generated: medias/缂栫爜.pngINFO  Generated: medias/featureimages/2.jpgINFO  Generated: libs/aplayer/APlayer.min.cssINFO  Generated: medias/featureimages/7.jpgINFO  Generated: libs/jqcloud/jqcloud-1.0.4.min.jsINFO  Generated: libs/codeBlock/codeBlockFuction.jsINFO  Generated: libs/background/canvas-nest.jsINFO  Generated: libs/minivaline/MiniValine.jsINFO  Generated: libs/others/clicklove.jsINFO  Generated: libs/instantpage/instantpage.jsINFO  Generated: libs/scrollprogress/scrollProgress.min.jsINFO  Generated: libs/prism/prism.cssINFO  Generated: libs/share/css/share.min.cssINFO  Generated: libs/tocbot/tocbot.min.jsINFO  Generated: libs/awesome/webfonts/fa-regular-400.woff2INFO  Generated: libs/lightGallery/fonts/lg.svgINFO  Generated: libs/lightGallery/fonts/lg.ttfINFO  Generated: libs/lightGallery/fonts/lg.woffINFO  Generated: libs/lightGallery/img/video-play.pngINFO  Generated: libs/share/fonts/iconfont.ttfINFO  Generated: libs/share/fonts/iconfont.svgINFO  Generated: libs/lightGallery/img/vimeo-play.pngINFO  Generated: libs/lightGallery/img/youtube-play.pngINFO  Generated: libs/share/fonts/iconfont.woffINFO  Generated: medias/featureimages/15.jpgINFO  Generated: css/gitment.cssINFO  Generated: css/my-gitalk.cssINFO  Generated: css/bb.cssINFO  Generated: js/search.jsINFO  Generated: css/my.cssINFO  Generated: libs/background/ribbon-dynamic.jsINFO  Generated: libs/background/ribbon-refresh.min.jsINFO  Generated: libs/background/ribbon.min.jsINFO  Generated: libs/codeBlock/codeLang.jsINFO  Generated: libs/codeBlock/codeCopy.jsINFO  Generated: libs/codeBlock/codeShrink.jsINFO  Generated: libs/others/busuanzi.pure.mini.jsINFO  Generated: libs/jqcloud/jqcloud.cssINFO  Generated: libs/tocbot/tocbot.cssINFO  Generated: medias/featureimages/10.jpgINFO  Generated: medias/featureimages/21.jpgINFO  Generated: medias/featureimages/3.jpgINFO  Generated: medias/featureimages/8.jpgINFO  Generated: medias/featureimages/5.jpgINFO  Generated: libs/awesome/webfonts/fa-regular-400.woffINFO  Generated: libs/gitalk/gitalk.cssINFO  Generated: libs/gitment/gitment-default.cssINFO  Generated: libs/masonry/masonry.pkgd.min.jsINFO  Generated: libs/share/js/jquery.share.min.jsINFO  Generated: libs/lightGallery/css/lightgallery.min.cssINFO  Generated: search.xmlINFO  Generated: medias/2_4.pngINFO  Generated: libs/awesome/webfonts/fa-regular-400.eotINFO  Generated: medias/featureimages/0.jpgINFO  Generated: medias/featureimages/17.jpgINFO  Generated: medias/featureimages/18.jpgINFO  Generated: medias/featureimages/19.jpgINFO  Generated: medias/featureimages/20.jpgINFO  Generated: medias/featureimages/4.jpgINFO  Generated: medias/featureimages/9.jpgINFO  Generated: 2021/08/31/virtuoso61x-xiu-gai-mo-ren-de-vi-bian-ji-qi/index.htmlINFO  Generated: libs/awesome/webfonts/fa-regular-400.ttfINFO  Generated: libs/awesome/webfonts/fa-brands-400.woff2INFO  Generated: 2021/09/02/shi-yong-matlab-zhong-ke-yong-yu-ji-suan-adc-zhi-biao/index.htmlINFO  Generated: libs/share/js/social-share.min.jsINFO  Generated: libs/aos/aos.cssINFO  Generated: medias/banner/0.jpgINFO  Generated: medias/featureimages/11.jpgINFO  Generated: medias/featureimages/6.jpgINFO  Generated: libs/awesome/webfonts/fa-brands-400.woffINFO  Generated: libs/awesome/webfonts/fa-solid-900.woff2INFO  Generated: libs/cryptojs/crypto-js.min.jsINFO  Generated: libs/dplayer/DPlayer.min.cssINFO  Generated: 2021/08/16/virtuoso61x-zhong-zuo-ams-fang-zhen-ji-lu/index.htmlINFO  Generated: 2021/08/30/yi-tian-5-ge-matlab-cheng-xu-1/index.htmlINFO  Generated: libs/awesome/webfonts/fa-brands-400.eotINFO  Generated: medias/鐜洖鎺ュ彛1.pngINFO  Generated: medias/featureimages/1.jpgINFO  Generated: medias/featureimages/12.jpgINFO  Generated: medias/featureimages/14.jpgINFO  Generated: libs/awesome/webfonts/fa-solid-900.woffINFO  Generated: libs/animate/animate.min.cssINFO  Generated: libs/lightGallery/js/lightgallery-all.min.jsINFO  Generated: css/matery.cssINFO  Generated: 2021/08/19/gnu-linux-de-yi-xie-cao-zuo-ji-yu-ubuntu/index.htmlINFO  Generated: 2021/08/31/sed-awk-de-yi-xie-chang-yong-ming-ling/index.htmlINFO  Generated: medias/banner/2.jpgINFO  Generated: medias/缂栫爜1.pngINFO  Generated: libs/awesome/webfonts/fa-brands-400.ttfINFO  Generated: medias/banner/3.jpgINFO  Generated: libs/aplayer/APlayer.min.jsINFO  Generated: 2021/08/30/shell-jiao-ben-ge-chong-fu-hao-de-han-yi/index.htmlINFO  Generated: libs/valine/Valine.min.jsINFO  Generated: libs/awesome/css/all.cssINFO  Generated: 2021/08/16/jiang-csv-zhuan-wei-dui-ying-de-hui-du-tu/index.htmlINFO  Generated: medias/banner/5.jpgINFO  Generated: libs/awesome/webfonts/fa-regular-400.svgINFO  Generated: medias/閲忓寲姒傝堪.pngINFO  Generated: medias/cover.jpgINFO  Generated: libs/gitment/gitment.jsINFO  Generated: medias/banner/6.jpgINFO  Generated: medias/banner/1.jpgINFO  Generated: 2021/08/16/ji-yu-python-de-wen-jian-chuan-shu-zhu-shou/index.htmlINFO  Generated: libs/jquery/jquery.min.jsINFO  Generated: libs/awesome/webfonts/fa-solid-900.eotINFO  Generated: libs/awesome/webfonts/fa-solid-900.ttfINFO  Generated: medias/reward/wechat.pngINFO  Generated: libs/dplayer/DPlayer.min.jsINFO  Generated: medias/reward/alipay.pngINFO  Generated: libs/materialize/materialize.min.cssINFO  Generated: libs/gitalk/gitalk.min.jsINFO  Generated: medias/banner/4.jpgINFO  Generated: libs/valine/av-min.jsINFO  Generated: medias/question.pngINFO  Generated: libs/materialize/materialize.min.jsINFO  Generated: medias/缂栫爜姒傝堪.pngINFO  Generated: libs/awesome/webfonts/fa-brands-400.svgINFO  Generated: libs/twikoo/twikoo.all.min.jsINFO  Generated: libs/awesome/webfonts/fa-solid-900.svgINFO  Generated: libs/echarts/echarts.min.jsINFO  Generated: medias/1.pngINFO  163 files generated <span class="token keyword">in</span> 641 ms</code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>使用Matlab计算ADC指标</title>
      <link href="2021/09/02/shi-yong-matlab-zhong-ke-yong-yu-ji-suan-adc-zhi-biao/"/>
      <url>2021/09/02/shi-yong-matlab-zhong-ke-yong-yu-ji-suan-adc-zhi-biao/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="前述"><a href="#前述" class="headerlink" title="前述"></a>前述</h3><p>  对ADC采样后的结果进行fft时需要满足采样信号、输入信号、采样点数和被采样周期个数之间的相干采样关系。<br>  也就是Fin/Fs=M/N,M是完整的输入信号周期的个数，N是完整的采样信号周期的个数。</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><pre class=" language-bash"><code class="language-bash">Data_in <span class="token operator">=</span> load<span class="token punctuation">(</span><span class="token string">'data.txt'</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token keyword">for</span> i <span class="token operator">=</span> 1:length<span class="token punctuation">(</span>Data_in<span class="token punctuation">)</span>    x<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token operator">=</span>Data_in<span class="token punctuation">(</span>i,1<span class="token punctuation">)</span><span class="token punctuation">;</span>end%x<span class="token punctuation">(</span>:,1<span class="token punctuation">)</span> <span class="token operator">=</span> str2num<span class="token punctuation">(</span>Data_in<span class="token punctuation">(</span>:,1<span class="token punctuation">))</span><span class="token punctuation">;</span>N <span class="token operator">=</span> length<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>Fs<span class="token operator">=</span>8e8<span class="token punctuation">;</span>%sample frequencyM<span class="token operator">=</span>5<span class="token punctuation">;</span>%number of signal periodxdft <span class="token operator">=</span> fft<span class="token punctuation">(</span>x<span class="token punctuation">)</span><span class="token punctuation">;</span>xdft <span class="token operator">=</span> xdft<span class="token punctuation">(</span>2:N/2+1<span class="token punctuation">)</span><span class="token punctuation">;</span>psdx <span class="token operator">=</span> <span class="token punctuation">(</span>1/<span class="token punctuation">(</span>Fs*N<span class="token punctuation">))</span> * abs<span class="token punctuation">(</span>xdft<span class="token punctuation">)</span>.^2<span class="token punctuation">;</span>psdx<span class="token punctuation">(</span>1:end-1<span class="token punctuation">)</span> <span class="token operator">=</span> 2*psdx<span class="token punctuation">(</span>1:end-1<span class="token punctuation">)</span><span class="token punctuation">;</span>freq <span class="token operator">=</span> Fs/N:Fs/N:Fs/2<span class="token punctuation">;</span>plot<span class="token punctuation">(</span>freq,10*log10<span class="token punctuation">(</span>psdx<span class="token punctuation">))</span><span class="token punctuation">;</span>grid offtitle<span class="token punctuation">(</span><span class="token string">'Power Spectrum Density'</span><span class="token punctuation">)</span>xlabel<span class="token punctuation">(</span><span class="token string">'Frequency (Hz)'</span><span class="token punctuation">)</span>ylabel<span class="token punctuation">(</span><span class="token string">'Power/Frequency (dB/Hz)'</span><span class="token punctuation">)</span>Ps <span class="token operator">=</span> psdx<span class="token punctuation">(</span>M<span class="token punctuation">)</span><span class="token punctuation">;</span>psdx<span class="token punctuation">(</span>M<span class="token punctuation">)</span> <span class="token operator">=</span> 0<span class="token punctuation">;</span>Pm <span class="token operator">=</span> max<span class="token punctuation">(</span>psdx<span class="token punctuation">)</span><span class="token punctuation">;</span>n<span class="token operator">=</span>2:9<span class="token punctuation">;</span>fharmonics<span class="token operator">=</span><span class="token punctuation">(</span>rem<span class="token punctuation">(</span>n*M,N<span class="token punctuation">)</span><span class="token operator">&lt;</span>N/2<span class="token punctuation">)</span>.*rem<span class="token punctuation">(</span>n*M,N<span class="token punctuation">)</span> + <span class="token punctuation">(</span>rem<span class="token punctuation">(</span>n*M,N<span class="token punctuation">)</span><span class="token operator">></span>N/2<span class="token punctuation">)</span>.*<span class="token punctuation">(</span>N-rem<span class="token punctuation">(</span>n*M,N<span class="token punctuation">))</span><span class="token punctuation">;</span>Pd <span class="token operator">=</span> sum<span class="token punctuation">(</span>psdx<span class="token punctuation">(</span>fharmonics<span class="token punctuation">))</span><span class="token punctuation">;</span>Pn <span class="token operator">=</span> sum<span class="token punctuation">(</span>psdx<span class="token punctuation">(</span>1:N/2<span class="token punctuation">))</span> - Pd<span class="token punctuation">;</span>THD<span class="token operator">=</span> 10*log10<span class="token punctuation">(</span>Pd/Ps<span class="token punctuation">)</span><span class="token punctuation">;</span>SNR<span class="token operator">=</span> 10*log10<span class="token punctuation">(</span>Ps/Pn<span class="token punctuation">)</span><span class="token punctuation">;</span>SNDR <span class="token operator">=</span> 10*log10<span class="token punctuation">(</span>Ps/<span class="token punctuation">(</span>Pn+Pd<span class="token punctuation">))</span><span class="token punctuation">;</span>ENOB <span class="token operator">=</span> <span class="token punctuation">(</span>SNDR - 1.76<span class="token punctuation">)</span>/6.02<span class="token punctuation">;</span>SFDR <span class="token operator">=</span> 10*log10<span class="token punctuation">(</span>Ps/Pm<span class="token punctuation">)</span><span class="token punctuation">;</span>texts <span class="token operator">=</span> sprintf<span class="token punctuation">(</span><span class="token string">'ENOB=%4.2f bits\nSNR=%4.2f dB\nSNDR=%4.2f dB\nTHD=%4.2f dB\nSFDR=%4.2f dB'</span>,ENOB,SNR,SNDR,THD,SFDR<span class="token punctuation">)</span><span class="token punctuation">;</span>text<span class="token operator">=</span><span class="token punctuation">(</span>texts<span class="token punctuation">)</span></code></pre><h4 id="结果展示"><a href="#结果展示" class="headerlink" title="结果展示"></a>结果展示</h4>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>sed&amp;awk的一些常用命令</title>
      <link href="2021/08/31/sed-awk-de-yi-xie-chang-yong-ming-ling/"/>
      <url>2021/08/31/sed-awk-de-yi-xie-chang-yong-ming-ling/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h4 id="6-sed-替换命令语法"><a href="#6-sed-替换命令语法" class="headerlink" title="6.sed 替换命令语法"></a>6.sed 替换命令语法</h4><p>sed ‘[address-range|pattern-range] s/original-string/replacement-string/[substitute-flags]’ input file </p><p>上面提到的语法为：  address-range 或 pattern-range(即地址范围和模式范围)是可选的。如果没有指 定，那么 sed 将在所有行上进行替换。  s 即执行替换命令 substitute  original-string 是被 sed 搜索然后被替换的字符串，它可以是一个正则表达式  replacement-string 替换后的字符串  substitute-flags 是可选的，下面会具体解释 </p><p>请谨记原始输入文件不会被修改，sed 只在模式空间中执行替换命令，然后输出模式空间的内容。</p><p>下面是一些简单的替换示例（替换的部分用黑体标明）<br>用 Director 替换所有行中的 Manager: </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token string">'s/Manager/Director/'</span> employee.txt 101,John Doe,CEO 102,Jason Smith,IT Director 103,Raj Reddy,Sysadmin 104,Anand Ram,Developer 105,Jane Miller,Sales Director </code></pre><p>只把包含 Sales 的行中的 Manager 替换为 Director: </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token string">'/Sales/s/Manager/Director/'</span> employee.txt 101,John Doe,CEO 102,Jason Smith,IT Manager  103,Raj Reddy,Sysadmin 104,Anand Ram,Developer 105,Jane Miller,Sales Director <span class="token comment" spellcheck="true">#注意：本例由于使用了地址范围限制，所以只有一个Manager被替换了</span></code></pre><h4 id="7-全局标志-g"><a href="#7-全局标志-g" class="headerlink" title="7.全局标志 g"></a>7.全局标志 g</h4><p>g 代表全局(global) 默认情况下，sed 至会替换每行中第一次出现的 original-string。如果你要 替换每行中出现的所有 original-string,就需要使用 g </p><p>用大写 A 替换第一次出现的小写字母 a： </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token string">'s/a/A/'</span> employee.txt 101,John Doe,CEO 102,JAson Smith,IT Manager 103,RAj Reddy,Sysadmin 104,AnAnd Ram,Developer 105,JAne Miller,Sales Manager </code></pre><p>把所有小写字母 a 替换为大写字母 A： </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token string">'s/a/A/g'</span> employee.txt 101,John Doe,CEO 102,JAson Smith,IT MAnAger 103,RAj Reddy,SysAdmin 104,AnAnd RAm,Developer 105,JAne Miller,SAles MAnAger <span class="token comment" spellcheck="true">#注意：上述例子会在所有行上替换，因为没有指定地址范围。 </span></code></pre><h4 id="8-数字标志-1-2-3-…"><a href="#8-数字标志-1-2-3-…" class="headerlink" title="8.数字标志(1,2,3 ….)"></a>8.数字标志(1,2,3 ….)</h4><p>使用数字可以指定 original-string 出现的次序。只有第 n 次出现的 original-string 才会触发替 换。每行的数字从 1 开始，最大为 512。<br>比如/11 会替换每行中第 11 次出现的 original-string<br>下面是几个例子： 把第二次出现的小写字母 a 替换为大写字母 A： </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token string">'s/a/A/2'</span> employee.txt 101,John Doe,CEO 102,Jason Smith,IT MAnager 103,Raj Reddy,SysAdmin 104,Anand RAm,Developer 105,Jane Miller,SAles Manager </code></pre><p>为了方面下面示例，请先建立如下文件：</p><pre class=" language-bash"><code class="language-bash">$ vim substitute-locate.txt <span class="token function">locate</span> <span class="token function">command</span> is used to <span class="token function">locate</span> files <span class="token function">locate</span> <span class="token function">command</span> uses database to <span class="token function">locate</span> files <span class="token function">locate</span> <span class="token function">command</span> can also use regex <span class="token keyword">for</span> searching </code></pre><p>使用刚才建立的文件，把每行中第二次出现的 locate 替换为 find: </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token string">'s/locate/find/2'</span> substitute-locate.txt <span class="token function">locate</span> <span class="token function">command</span> is used to <span class="token function">find</span> files <span class="token function">locate</span> <span class="token function">command</span> uses database to <span class="token function">find</span> files <span class="token function">locate</span> <span class="token function">command</span> can also use regex <span class="token keyword">for</span> searching <span class="token comment" spellcheck="true">#注意：第 3 行中 locate 只出现了一次，所以没有替换任何内容 </span></code></pre><h4 id="9-打印标志-p-print"><a href="#9-打印标志-p-print" class="headerlink" title="9.打印标志 p(print)"></a>9.打印标志 p(print)</h4><p>命令 p 代表 print。当替换操作完成后，打印替换后的行。与其他打印命令类似，sed 中比较 有用的方法是和-n 一起使用以抑制默认的打印操作。 </p><p>只打印替换后的行： </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> -n <span class="token string">'s/John/Johnny/p'</span> employee.txt 101,Johnny Doe,CEO </code></pre><p>在之前的数字标志的例子中，使用/2 来替换第二次出现的 locate。第 3 行中 locate 只出现了 一次，所以没有替换任何内容。使用 p 标志可以只打印替换过的两行.<br>把每行中第二次出现的 locate 替换为 find 并打印出来： </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> -n <span class="token string">'s/locate/find/2p'</span> substitute-locate.txt <span class="token function">locate</span> <span class="token function">command</span> is used to <span class="token function">find</span> files locate <span class="token function">command</span> uses database to <span class="token function">find</span> files </code></pre><h4 id="10-写标志-w"><a href="#10-写标志-w" class="headerlink" title="10.写标志 w"></a>10.写标志 w</h4><p>标志 w 代表 write。当替换操作执行成功后，它把替换后的结果保存的文件中。多数人更倾 向于使用 p 打印内容，然后重定向到文件中。为了对 sed 标志有个完整的描述，在这里把这 个标志也提出来了。<br>只把替换后的内容写到 output.txt 中: </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> -n <span class="token string">'s/John/Johnny/w output.txt'</span> employee.txt $ <span class="token function">cat</span> output.txt 101,Johnny Doe,CEO <span class="token comment" spellcheck="true">#和之前使用的命令 p 一样，使用 w 会把替换后的内容保存到文件 output.txt 中。 </span></code></pre><p>把每行第二次出现的 locate 替换为 find，把替换的结果保存到文件中，同时显示输入文件所有内容： </p><pre class=" language-bash"><code class="language-bash">$ <span class="token function">sed</span> <span class="token string">'s/locate/find/2w output.txt'</span> substitute-locate.txt <span class="token function">locate</span> <span class="token function">command</span> is used to <span class="token function">find</span> files <span class="token function">locate</span> <span class="token function">command</span> uses database to <span class="token function">find</span> files <span class="token function">locate</span> <span class="token function">command</span> can also use regex <span class="token keyword">for</span> searching </code></pre><pre class=" language-bash"><code class="language-bash">$ <span class="token function">cat</span> output.txt <span class="token function">locate</span> <span class="token function">command</span> is used to <span class="token function">find</span> files <span class="token function">locate</span> <span class="token function">command</span> uses database to <span class="token function">find</span> files </code></pre>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Virtuoso61X修改默认的VI编辑器</title>
      <link href="2021/08/31/virtuoso61x-xiu-gai-mo-ren-de-vi-bian-ji-qi/"/>
      <url>2021/08/31/virtuoso61x-xiu-gai-mo-ren-de-vi-bian-ji-qi/</url>
      
        <content type="html"><![CDATA[<h3 id="操作步骤"><a href="#操作步骤" class="headerlink" title="操作步骤"></a>操作步骤</h3><h4 id="1-进入打开Virtuoso的文件夹下"><a href="#1-进入打开Virtuoso的文件夹下" class="headerlink" title="1.进入打开Virtuoso的文件夹下"></a>1.进入打开Virtuoso的文件夹下</h4><h4 id="2-输入bash-ls-al-或者输入bash-find-iname-quot-cdsinit-quot-type-f-2-gt-gt-dev-null-找到该文件夹下的-cdsinit文件，这个默认状态下是隐藏文件"><a href="#2-输入bash-ls-al-或者输入bash-find-iname-quot-cdsinit-quot-type-f-2-gt-gt-dev-null-找到该文件夹下的-cdsinit文件，这个默认状态下是隐藏文件" class="headerlink" title="2.输入bash ls -al ,或者输入bash find . -iname &quot;.cdsinit*&quot; -type f 2&gt;&gt;/dev/null  找到该文件夹下的.cdsinit文件，这个默认状态下是隐藏文件."></a>2.输入<code>bash ls -al </code>,或者输入<code>bash find . -iname &quot;.cdsinit*&quot; -type f 2&gt;&gt;/dev/null </code> 找到该文件夹下的.cdsinit文件，这个默认状态下是隐藏文件.</h4><h4 id="3-用自己熟悉的方式打开这个文件，里面的内容是Virtuoso打开时的初始化信息，包括了编写Verilog-a-ams-代码时的默认编辑器，此处用的是Vim。-滑稽-滑稽-滑稽"><a href="#3-用自己熟悉的方式打开这个文件，里面的内容是Virtuoso打开时的初始化信息，包括了编写Verilog-a-ams-代码时的默认编辑器，此处用的是Vim。-滑稽-滑稽-滑稽" class="headerlink" title="3.用自己熟悉的方式打开这个文件，里面的内容是Virtuoso打开时的初始化信息，包括了编写Verilog(a/ams)代码时的默认编辑器，此处用的是Vim。/滑稽/滑稽/滑稽"></a>3.用自己熟悉的方式打开这个文件，里面的内容是Virtuoso打开时的初始化信息，包括了编写Verilog(a/ams)代码时的默认编辑器，此处用的是Vim。/滑稽/滑稽/滑稽</h4><h4 id="4-找到“editor”这个选项，例如在vim中先按下ESC转到命令模式，然后按下”-“-”editor”，然后回车就可以找到和editor匹配的字符串，修改右侧的Vi为emacs或者gedit。需要注意的是，可能系统中不一定存在emacs可以使用，因此当键入emacs无效之后，可以换成gedit。"><a href="#4-找到“editor”这个选项，例如在vim中先按下ESC转到命令模式，然后按下”-“-”editor”，然后回车就可以找到和editor匹配的字符串，修改右侧的Vi为emacs或者gedit。需要注意的是，可能系统中不一定存在emacs可以使用，因此当键入emacs无效之后，可以换成gedit。" class="headerlink" title="4.找到“editor”这个选项，例如在vim中先按下ESC转到命令模式，然后按下”/“+”editor”，然后回车就可以找到和editor匹配的字符串，修改右侧的Vi为emacs或者gedit。需要注意的是，可能系统中不一定存在emacs可以使用，因此当键入emacs无效之后，可以换成gedit。"></a>4.找到“editor”这个选项，例如在vim中先按下ESC转到命令模式，然后按下”/“+”editor”，然后回车就可以找到和editor匹配的字符串，修改右侧的Vi为emacs或者gedit。需要注意的是，可能系统中不一定存在emacs可以使用，因此当键入emacs无效之后，可以换成gedit。</h4><h4 id="5-保存，退出，打开virtuoso。"><a href="#5-保存，退出，打开virtuoso。" class="headerlink" title="5.保存，退出，打开virtuoso。"></a>5.保存，退出，打开virtuoso。</h4>]]></content>
      
      
      
        <tags>
            
            <tag> Virtuoso </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>一天5个Matlab程序[1]</title>
      <link href="2021/08/30/yi-tian-5-ge-matlab-cheng-xu-1/"/>
      <url>2021/08/30/yi-tian-5-ge-matlab-cheng-xu-1/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>在matlab的editor(command windows里面输入Editor即可,从Editor转到command windows可以按快捷键ctrl+0)键入代码，保存后运行即可。</p><h4 id="1-三角函数曲线"><a href="#1-三角函数曲线" class="headerlink" title="1.三角函数曲线"></a>1.三角函数曲线</h4><pre class=" language-shell"><code class="language-shell">function exmaple_l h0=figure('toolbar','none','position',[198 56 350 200],'name",'实例01');h1=axes('parent',h0,'visible','off');x=-pi：0.05：pi;y=sin(x);plot(x,y);xlabel('自变量X');ylabel('函数值Y');title('SIN)函数曲线);grid on</code></pre><h4 id="2-图形叠加"><a href="#2-图形叠加" class="headerlink" title="2.图形叠加"></a>2.图形叠加</h4><pre class=" language-shell"><code class="language-shell">function exmaple_2h0=figure('tool bar','none','position',[200 150 450 350],'name,'实例03');x=-pi：0.05：pi;yl=sin(x);y2=cos(x);plot(x,y1,'-*r’,x,y2,'--og');grid onxlabel('自变量X');ylabel('函数值Y');title('三角函数');</code></pre><h4 id="3-双y轴图形的绘制"><a href="#3-双y轴图形的绘制" class="headerlink" title="3.双y轴图形的绘制"></a>3.双y轴图形的绘制</h4><pre class=" language-shell"><code class="language-shell">function shili04h0-figure('tool bar','none','position',[200 150 450 250],name',实例04');x=0:900;a=1000;b=0.005;y1=2*x;y2=cos(b*x);[haxes,hlinel,hline2]=plotyy(x,y1,x,y2,'semilogy','plot');axes(haxes(1))ylabel('semilog plot');axes(haxes(2))ylabel('linear plot');</code></pre><h4 id="4-区域图形绘制"><a href="#4-区域图形绘制" class="headerlink" title="4.区域图形绘制"></a>4.区域图形绘制</h4><pre class=" language-shell"><code class="language-shell">function example_08h0=figure('toolbar','none','position',[200,150,450,250],'name','example_08');x=91:95;profits1=[88,75,84,93,77];profits2=[51,65,54,56,68];profits3=[42,54,35,25,24];profits4=[26,38,18,15,4];% area函数将每个矩阵中的同一行的元素相叠加，一个矩阵中有多少行，就有多少个area的颜色area(x,profits1,'facecolor',[0.5 0.9 0.6],...    'edgecolor','b','linewidth',3);hold on area(x,profits2,'facecolor',[0.9 0.85 0.7],...    'edgecolor','y','linewidth',3);area(x,profits3,'facecolor',[0.3 0.6 0.7],...    'edgecolor','r','linewidth',3);area(x,profits4,'facecolor',[0.6 0.5 0.9],...    'edgecolor','m','linewidth',3);hold offset(gca,'xtick',[91:95]);set(gca,'layer','top');gtext('\leftarrow第一季度销量');gtext('\leftarrow第二季度销量');gtext('\leftarrow第三季度销量');gtext('\leftarrow第四季度销量');xlabel('年','fontsize',16);ylabel('销售量','fontsize',16);</code></pre><h4 id="5-灰色预测【统计预测模型】"><a href="#5-灰色预测【统计预测模型】" class="headerlink" title="5.灰色预测【统计预测模型】"></a>5.灰色预测【统计预测模型】</h4><pre class=" language-shell"><code class="language-shell">syms a bc=[a,b]';promt='data input:';%A=input(promt);A=[94.12,106.66,108.24,116.5,150.8];B=cumsum(A);n=length(A);for i=1:(n-1)    C(i)=(B(i)+B(i+1))/2;endE=[-C;ones(1,n-1)];D=A;D(1)=[];D=D';c=(E*E')\E*D;c=c';a=c(1);b=c(2);F=[];F(1)=A(1);for i=2:(n+2)    F(i)=(A(1)-b/a)*exp(-a*(i-1))+b/a;endG=[];G(1)=A(1);for i=2:(n+2)    G(i)=F(i)-F(i-1);enda bGt1=1985:1989;t2=1985:1991;plot(t1,A,'*');hold onplot(t2,G,'r');datacursormode on</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> Matlab </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shell脚本各种符号的含义</title>
      <link href="2021/08/30/shell-jiao-ben-ge-chong-fu-hao-de-han-yi/"/>
      <url>2021/08/30/shell-jiao-ben-ge-chong-fu-hao-de-han-yi/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="解释"><a href="#解释" class="headerlink" title="解释"></a>解释</h3><pre class=" language-bash"><code class="language-bash">$$Shell本身的PID（ProcessID）<span class="token variable">$!</span>Shell最后运行的后台Process的PID<span class="token variable">$?</span>最后运行的命令的结束代码（返回值）$-使用Set命令设定的Flag一览<span class="token variable">$*</span>所有参数列表。如<span class="token string">"<span class="token variable">$*</span>"</span>用「<span class="token string">"」括起来的情况、以"</span><span class="token variable">$1</span> <span class="token variable">$2</span> … <span class="token variable">$n</span><span class="token string">"的形式输出所有参数。<span class="token variable">$@</span>所有参数列表。如"</span><span class="token variable">$@</span><span class="token string">"用「"</span>」括起来的情况、以<span class="token string">"<span class="token variable">$1</span>"</span> <span class="token string">"<span class="token variable">$2</span>"</span> … <span class="token string">"<span class="token variable">$n</span>"</span> 的形式输出所有参数。$<span class="token comment" spellcheck="true">#</span>添加到Shell的参数个数<span class="token variable">$0</span>Shell本身的文件名<span class="token variable">$1</span>～<span class="token variable">$n</span>添加到Shell的各参数值。<span class="token variable">$1</span>是第1参数、<span class="token variable">$2</span>是第2参数…</code></pre><h3 id="举例"><a href="#举例" class="headerlink" title="举例"></a>举例</h3><pre class=" language-bash"><code class="language-bash">$ <span class="token function">cat</span> <span class="token operator">></span> <span class="token function">file</span><span class="token comment" spellcheck="true">#!/bin/bash</span><span class="token keyword">echo</span> <span class="token string">"number: <span class="token variable">$#</span>"</span><span class="token keyword">echo</span> <span class="token string">"first_arg: <span class="token variable">$1</span>"</span><span class="token keyword">echo</span> <span class="token string">"second_arg: <span class="token variable">$2</span>"</span><span class="token keyword">echo</span> <span class="token string">"all_arg: <span class="token variable">$@</span>"</span></code></pre><h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><pre class=" language-bash"><code class="language-bash">$ <span class="token function">file</span> a b cnumber: 3first_arg: asecond_arg: ball_arg: c</code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> bash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>GNU/Linux的一些操作（基于ubuntu）</title>
      <link href="2021/08/19/gnu-linux-de-yi-xie-cao-zuo-ji-yu-ubuntu/"/>
      <url>2021/08/19/gnu-linux-de-yi-xie-cao-zuo-ji-yu-ubuntu/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="1-list-net-info-sh"><a href="#1-list-net-info-sh" class="headerlink" title="1.list_net_info.sh"></a>1.list_net_info.sh</h3><pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span>IP<span class="token operator">=</span>`ifconfig eth0 <span class="token operator">|</span> <span class="token function">head</span> -2 <span class="token operator">|</span> <span class="token function">tail</span> -1 <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&amp;#123;print <span class="token variable">$2</span>&amp;#125;'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">":"</span> <span class="token string">'&amp;#123;print <span class="token variable">$2</span>&amp;#125;'</span>`ZW<span class="token operator">=</span>` <span class="token function">ifconfig</span> eth0 <span class="token operator">|</span> <span class="token function">head</span> -2 <span class="token operator">|</span> <span class="token function">tail</span> -1 <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&amp;#123;print <span class="token variable">$3</span>&amp;#125;'</span> <span class="token operator">|</span> <span class="token function">awk</span> -F<span class="token string">":"</span> <span class="token string">'&amp;#123;print <span class="token variable">$2</span>&amp;#125;'</span>`GW<span class="token operator">=</span>`route -n <span class="token operator">|</span> <span class="token function">tail</span> -1 <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&amp;#123;print <span class="token variable">$2</span>&amp;#125;'</span>`HN<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">hostname</span><span class="token variable">`</span></span>DNS<span class="token operator">=</span>`head -1 /etc/resolv.conf <span class="token operator">|</span> <span class="token function">awk</span> <span class="token string">'&amp;#123;print <span class="token variable">$2</span>&amp;#125;'</span>`<span class="token keyword">echo</span> <span class="token string">'此机IP地址是'</span> <span class="token variable">$IP</span><span class="token keyword">echo</span> <span class="token string">'此机子网掩码是'</span> <span class="token variable">$ZW</span><span class="token keyword">echo</span> <span class="token string">'此机网关是'</span> <span class="token variable">$GW</span><span class="token keyword">echo</span> <span class="token string">'此机主机名是'</span> <span class="token variable">$HN</span><span class="token keyword">echo</span> <span class="token string">'此机DNS是'</span> <span class="token variable">$DNS</span></code></pre><h3 id="2-virtuoso-1-sh-自动将某个文件夹下的文件添加到cds-lib中（有可能会添加重复的语句）"><a href="#2-virtuoso-1-sh-自动将某个文件夹下的文件添加到cds-lib中（有可能会添加重复的语句）" class="headerlink" title="2.virtuoso_1.sh[自动将某个文件夹下的文件添加到cds.lib中（有可能会添加重复的语句）]"></a>2.virtuoso_1.sh[自动将某个文件夹下的文件添加到cds.lib中（有可能会添加重复的语句）]</h3><pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment" spellcheck="true">#this file is designed for this kind of situation</span><span class="token comment" spellcheck="true">#the libraries are in dir A, and there are a number of libraries</span><span class="token comment" spellcheck="true">#and the cds.lib is at anywhere accessible</span><span class="token comment" spellcheck="true">#and this file is to add these libraries into the cds.lib</span>num<span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">ls</span> -l <span class="token operator">|</span> <span class="token function">wc</span> -l <span class="token variable">)</span></span><span class="token keyword">echo</span> <span class="token string">"number is <span class="token variable"><span class="token variable">$((</span>$num <span class="token operator">-</span> <span class="token number">1</span><span class="token variable">))</span></span>"</span><span class="token comment" spellcheck="true">#echo $(ls -l) | xargs -0 cut -d '' -f 9 </span>file_list<span class="token operator">=</span>`ls -l <span class="token operator">|</span> <span class="token function">tail</span> -7 <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token keyword">:</span> -f 2 <span class="token operator">|</span> <span class="token function">cut</span> -d <span class="token string">' '</span> -f 2 `<span class="token keyword">echo</span> <span class="token variable">$file_list</span><span class="token keyword">echo</span> <span class="token string">"input the position of cds.lib file:"</span><span class="token function">read</span> cdspos<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$cdspos</span> <span class="token operator">=</span> <span class="token string">'.'</span> <span class="token punctuation">]</span><span class="token keyword">then</span>cdspos<span class="token operator">=</span><span class="token variable"><span class="token variable">`</span><span class="token function">pwd</span><span class="token variable">`</span></span><span class="token keyword">else</span><span class="token function">sleep</span> 1<span class="token keyword">fi</span><span class="token keyword">echo</span> <span class="token string">"cdspos is <span class="token variable">$cdspos</span>"</span><span class="token keyword">echo</span> <span class="token string">"#############################################this is newly added#############################"</span><span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token variable">$file_list</span><span class="token keyword">do</span>str<span class="token operator">=</span><span class="token string">"<span class="token variable">$cdspos</span>/<span class="token variable">$i</span>"</span><span class="token keyword">echo</span> <span class="token variable">$str</span> <span class="token operator">>></span> cds.lib<span class="token keyword">done</span><span class="token keyword">echo</span> <span class="token string">"done"</span></code></pre><h3 id="3-ip-online-sh"><a href="#3-ip-online-sh" class="headerlink" title="3.ip_online.sh"></a>3.ip_online.sh</h3><pre class=" language-bash"><code class="language-bash"><span class="token shebang important">#!/bin/bash</span><span class="token comment" spellcheck="true">#输出192.168.1.0/255网段内在线主机的ip地址</span><span class="token comment" spellcheck="true">#统计不在线主机的台数，并把不在线主机的ip地址和不在线时的时间保存到/tmp/ip.txt文件里</span><span class="token comment" spellcheck="true">#!/bin/bash</span>ip<span class="token operator">=</span>192.168.1.j<span class="token operator">=</span>0<span class="token keyword">for</span> i <span class="token keyword">in</span> <span class="token variable"><span class="token variable">`</span><span class="token function">seq</span> 1 255<span class="token variable">`</span></span><span class="token keyword">do</span><span class="token function">ping</span> -c 3 <span class="token variable">$ip</span><span class="token variable">$i</span> <span class="token operator">&amp;</span><span class="token operator">></span> /dev/null<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$?</span> -eq 0 <span class="token punctuation">]</span><span class="token punctuation">;</span><span class="token keyword">then</span><span class="token keyword">echo</span> 在线的主机有：<span class="token variable">$ip</span><span class="token variable">$i</span><span class="token keyword">else</span><span class="token keyword">let</span> j++<span class="token keyword">echo</span> <span class="token variable">$ip</span><span class="token variable">$i</span> <span class="token operator">>></span> /tmp/ip.txt<span class="token function">date</span> <span class="token operator">>></span> /tmp/ip.txt<span class="token keyword">fi</span><span class="token keyword">done</span><span class="token keyword">echo</span> 不在线的主机台数有 <span class="token variable">$j</span></code></pre><p>4.</p>]]></content>
      
      
      
        <tags>
            
            <tag> bash </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Virtuoso61x中做ams仿真记录</title>
      <link href="2021/08/16/virtuoso61x-zhong-zuo-ams-fang-zhen-ji-lu/"/>
      <url>2021/08/16/virtuoso61x-zhong-zuo-ams-fang-zhen-ji-lu/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="记录"><a href="#记录" class="headerlink" title="记录"></a>记录</h3><h4 id="1"><a href="#1" class="headerlink" title="1."></a>1.</h4><p>  不要在cds.lib里面定义一个名称全部为数字的工程文件夹;</p><h4 id="2"><a href="#2" class="headerlink" title="2."></a>2.</h4><p>  需要在服务器的cadence文件夹下找一下IUSxx,在该目录下找到connectLib文件夹,整个复制到自己的工作目录下或者定义好绝对路径。<br>connectLib中定义的是关于数字模块接口电压等等的定义,所以是做ams混合信号电路仿真时必需的。</p><h4 id="3"><a href="#3" class="headerlink" title="3."></a>3.</h4><p>  IC617版本的virtuoso需要INCISIVE132以及更高版本的，INCISIVE最后一版更新完成于2015年，最后一版是152版本的，irun -version可以查看INCISIVE的版本；之后的Virtuoso版本需要的是Xcelillum.</p><h4 id="4"><a href="#4" class="headerlink" title="4."></a>4.</h4><p>  关于ams仿真提示error，cannot compile ahdlcmi file….,这个是由于lib无法转换导致的。<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/error1.jpg" alt="lib转换失败导致的错误"><br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/system_lib1.png" alt="virtuoso版本所对应的系统库"><br>  也即这里的一些库索引需要修改为Virtuoso版本匹配的。【可能系统中同时有615和617多个版本，然后在bashrc和.cshrc中需要区分，在cds.lib中也要调用正确对应的系统库】</p><h4 id="5"><a href="#5" class="headerlink" title="5."></a>5.</h4><p>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/system_lib2.png" alt="cds.lib中添加connect_lib"><br>  include所定义的库也要写。include进来的cds.lib软链接到一些其他的库和connectlib，会调用一些virtuoso下的库，然后在incisiv下编译。</p><h4 id="6"><a href="#6" class="headerlink" title="6."></a>6.</h4><p>  像站主的虚拟机里面同时有IC615和IC617的版本，但是INCISIVE的版本只有131（2013年推出，最后的版本是152），那这就没有选择只好调整Virtuoso打开的虚拟机的版本为615，这个在home目录下的.bashrc文件中就可以做到，将其中关于617版本以及ov文件夹的相关定义注释掉并且改成615版本的即可。一般情况下只需要修改下面两个地方。<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/bashrc.png" alt="修改home目录下的.bashrc文件"><br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/cdslib.png" alt="修改cds.lib文件"></p><h3 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h3><h4 id="1-1"><a href="#1-1" class="headerlink" title="1."></a>1.</h4><p>  大致的介绍一下ams的仿真流程，首先是需要单独的建立一个digital模块，一般的为了提高仿真的效率，会使用verilog代码来代替实际的数字电路，然后需要建立一个verilog模块，通过File-&gt;new-&gt;cellview，在类型中选择verilog即可。<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/inv_verilog.png" alt="编写Verilog代码文件"><br>  或许会有的打开的verilog编辑器默认是VI(M)，VIM编辑器对于刚入手的人可能会显得比较奇怪，例如不支持ctrl+c和ctrl+v的复制粘贴操作，还有一个经典的笑话是新手关于怎么退出vim编辑器，不过熟悉了之后这真的是一个效率极高的文本编辑器。<br>  可以参考另一篇文章<a href="https://roc-may.github.io/2021/08/31/virtuoso61x-xiu-gai-mo-ren-de-vi-bian-ji-qi/">Virtuoso61X修改默认的VI编辑器</a>修改。</p><h4 id="2-1"><a href="#2-1" class="headerlink" title="2."></a>2.</h4><p>  之后可以新建一个类型为schematic的电路图，然后想例图中这样添加仿真所需要用到的模拟模块和数字模块。<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/full_inv_ams.png" alt="新建一个包含模拟电路和数字电路的schematic"><br>  之后，需要新建一个类型为config，名称和所建的schematic一样的config文件。<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/inv_config.png" alt="建立schematic对应的config文件，注意文件是一定是同名的"><br>  之后，需要添加<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/config_1.png" alt="建立config文件的第一步"><br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/config_2.png" alt="建立config文件的第二步"><br>  选好之后点击OK。<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/config_3.png" alt="建立config文件的第三步"></p><h4 id="3-1"><a href="#3-1" class="headerlink" title="3."></a>3.</h4><p>  接下来是很重要的步骤，添加connect_lib信息进行模拟电路接口和数字电路接口之前的连接，因为从连续信号到数字信号的转变是需要转换规则的，因此这个lib的添加是必须的。<br>  添加的时候需要注意的部分是：</p><h5 id="I"><a href="#I" class="headerlink" title="I."></a>I.</h5><p>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/system_lib2.png" alt="cds.lib中添加connect_lib"><br>  如上图所示，在cds.lib中需要包含这两个其他路径下对应的cds.lib文件，其中所写的内容也只是软链接到其他的cds.lib。</p><h5 id="II"><a href="#II" class="headerlink" title="II."></a>II.</h5><p>  除此之外，在ADE中需要确认一下setup-&gt;simulator的mode是ams而不是spectre，否则是不会进行ams仿真的。IC617及以后的版本在通过config文件打开时，仿真引擎会主动换成ams，615版本的需要手动修改。<br>  在仿真是ams模式下也可以开启aps多核仿真，注意是设置thread线程数。<br>  【确认一下服务器上仿真可调用的核的个数：</p><pre class=" language-bash"><code class="language-bash"><span class="token comment" spellcheck="true">#查询系统有几颗物理CPU</span><span class="token function">cat</span>  /proc/cpuinfo <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"physical id"</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token comment" spellcheck="true">#查询系统每颗物理CPU的核心数</span><span class="token function">cat</span> /proc/cpuinfo <span class="token operator">|</span> <span class="token function">grep</span> <span class="token string">"cpu cores"</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token comment" spellcheck="true">#查询系统的每颗物理CPU核心是否启用超线程技术。如果有启用,那么每个物理核心又可分为两个逻辑处理器</span><span class="token function">cat</span> /proc/cpuinfo <span class="token operator">|</span> <span class="token function">grep</span> -e <span class="token string">"cpu cores"</span>  -e <span class="token string">"siblings"</span> <span class="token operator">|</span> <span class="token function">sort</span> <span class="token operator">|</span> <span class="token function">uniq</span> <span class="token operator">|</span> <span class="token function">wc</span> -l<span class="token comment" spellcheck="true">#查看CPU主频</span><span class="token function">cat</span> /proc/cpuinfo <span class="token operator">|</span> <span class="token function">grep</span> MHz <span class="token operator">|</span> <span class="token function">uniq</span></code></pre><h3 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h3><p>  可能会有人遇到gcc编译出现问题的情况，如下图所示。<br>  <img src="https://gitee.com/Gui_xin_peng/picture_warehouse/raw/master/img/gccerror.jpg" alt="avatar"><br>  像是上图中的情况，是由于红框中路径所对应的目录下gcc是一个失效的symbolic link文件，软链接到一个无效的gcc【可能是丢失了或者换了位置】，所以只需要用ln命令将gcc的软链接修改到一个已知版本的gcc（大于2.4版本）即可。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Virtuoso </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>基于python的文件传输助手</title>
      <link href="2021/08/16/ji-yu-python-de-wen-jian-chuan-shu-zhu-shou/"/>
      <url>2021/08/16/ji-yu-python-de-wen-jian-chuan-shu-zhu-shou/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="操作环境"><a href="#操作环境" class="headerlink" title="操作环境"></a>操作环境</h3><p>python3.6+ubuntu18.04</p><h3 id="操作方法"><a href="#操作方法" class="headerlink" title="操作方法"></a>操作方法</h3><p>终端中输入<br>python3 -m http.server（写python3是为了避免在系统同时存在python2和python3时，和python2冲突）<br>打开手机浏览器，网址栏输入<br>你的电脑ip:8000<br>例如：192.168.<strong><em>.</em></strong>:8000<br>监听你的电脑的8000号端口就行，这样你就可以看到你的电脑里面的文件了。</p><h3 id="注意事项"><a href="#注意事项" class="headerlink" title="注意事项"></a>注意事项</h3><p>注意哦，手机和电脑要在同一个局域网下面，也就是说要连一个网。<br>不过就是只能看，不能上传，有升级的空间。<br>github上看到过一个不错的脚本，分享一下。</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><pre class=" language-python"><code class="language-python"><span class="token comment" spellcheck="true">#!/usr/bin/env python3</span><span class="token triple-quoted-string string">"""Simple HTTP Server With Upload.This module builds on http.server by implementing the standard GETand HEAD requests in a fairly straightforward manner.see: https://gist.github.com/UniIsland/3346170"""</span>__version__ <span class="token operator">=</span> <span class="token string">"0.1"</span>__all__ <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">"SimpleHTTPRequestHandler"</span><span class="token punctuation">]</span>__author__ <span class="token operator">=</span> <span class="token string">"bones7456"</span>__home_page__ <span class="token operator">=</span> <span class="token string">"https://gist.github.com/UniIsland/3346170"</span><span class="token keyword">import</span> os<span class="token keyword">import</span> posixpath<span class="token keyword">import</span> http<span class="token punctuation">.</span>server<span class="token keyword">import</span> socketserver<span class="token keyword">import</span> urllib<span class="token punctuation">.</span>request<span class="token punctuation">,</span> urllib<span class="token punctuation">.</span>parse<span class="token punctuation">,</span> urllib<span class="token punctuation">.</span>error<span class="token keyword">import</span> html<span class="token keyword">import</span> shutil<span class="token keyword">import</span> mimetypes<span class="token keyword">import</span> re<span class="token keyword">import</span> argparse<span class="token keyword">import</span> base64<span class="token keyword">from</span> io <span class="token keyword">import</span> BytesIO<span class="token keyword">class</span> <span class="token class-name">SimpleHTTPRequestHandler</span><span class="token punctuation">(</span>http<span class="token punctuation">.</span>server<span class="token punctuation">.</span>BaseHTTPRequestHandler<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""Simple HTTP request handler with GET/HEAD/POST commands.    This serves files from the current directory and any of its    subdirectories.  The MIME type for files is determined by    calling the .guess_type() method. And can reveive file uploaded    by client.    The GET/HEAD/POST requests are identical except that the HEAD    request omits the actual contents of the file.    """</span>    server_version <span class="token operator">=</span> <span class="token string">"SimpleHTTPWithUpload/"</span> <span class="token operator">+</span> __version__    <span class="token keyword">def</span> <span class="token function">do_GET</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Serve a GET request."""</span>        f <span class="token operator">=</span> self<span class="token punctuation">.</span>send_head<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> f<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>copyfile<span class="token punctuation">(</span>f<span class="token punctuation">,</span> self<span class="token punctuation">.</span>wfile<span class="token punctuation">)</span>            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_HEAD</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Serve a HEAD request."""</span>        f <span class="token operator">=</span> self<span class="token punctuation">.</span>send_head<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> f<span class="token punctuation">:</span>            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">do_POST</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Serve a POST request."""</span>        r<span class="token punctuation">,</span> info <span class="token operator">=</span> self<span class="token punctuation">.</span>deal_post_data<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> info<span class="token punctuation">,</span> <span class="token string">"by: "</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>client_address<span class="token punctuation">)</span><span class="token punctuation">)</span>        f <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;html>\n&lt;title>Upload Result Page&lt;/title>\n"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;body>\n&lt;h2>Upload Result Page&lt;/h2>\n"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;hr>\n"</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> r<span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;strong>Success:&lt;/strong>"</span><span class="token punctuation">)</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;strong>Failed:&lt;/strong>"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>info<span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"&lt;br>&lt;a href=\"%s\">back&lt;/a>"</span> <span class="token operator">%</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'referer'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;hr>&lt;small>Powered By: bones7456, check new version at "</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;a href=\"https://gist.github.com/UniIsland/3346170\">"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"here&lt;/a>.&lt;/small>&lt;/body>\n&lt;/html>\n"</span><span class="token punctuation">)</span>        length <span class="token operator">=</span> f<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> f<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>copyfile<span class="token punctuation">(</span>f<span class="token punctuation">,</span> self<span class="token punctuation">.</span>wfile<span class="token punctuation">)</span>            f<span class="token punctuation">.</span>close<span class="token punctuation">(</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">deal_post_data</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        uploaded_files <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>        content_type <span class="token operator">=</span> self<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-type'</span><span class="token punctuation">]</span>        <span class="token keyword">if</span> <span class="token operator">not</span> content_type<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"Content-Type header doesn't contain boundary"</span><span class="token punctuation">)</span>        boundary <span class="token operator">=</span> content_type<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">"="</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span>        remainbytes <span class="token operator">=</span> int<span class="token punctuation">(</span>self<span class="token punctuation">.</span>headers<span class="token punctuation">[</span><span class="token string">'content-length'</span><span class="token punctuation">]</span><span class="token punctuation">)</span>        line <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>        remainbytes <span class="token operator">-=</span> len<span class="token punctuation">(</span>line<span class="token punctuation">)</span>        <span class="token keyword">if</span> <span class="token operator">not</span> boundary <span class="token keyword">in</span> line<span class="token punctuation">:</span>            <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"Content NOT begin with boundary"</span><span class="token punctuation">)</span>        <span class="token keyword">while</span> remainbytes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>            line <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>            remainbytes <span class="token operator">-=</span> len<span class="token punctuation">(</span>line<span class="token punctuation">)</span>            fn <span class="token operator">=</span> re<span class="token punctuation">.</span>findall<span class="token punctuation">(</span>r<span class="token string">'Content-Disposition.*name="file"; filename="(.*)"'</span><span class="token punctuation">,</span> line<span class="token punctuation">.</span>decode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>            <span class="token keyword">if</span> <span class="token operator">not</span> fn<span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"Can't find out file name..."</span><span class="token punctuation">)</span>            path <span class="token operator">=</span> self<span class="token punctuation">.</span>translate_path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span>            fn <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> fn<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            line <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>            remainbytes <span class="token operator">-=</span> len<span class="token punctuation">(</span>line<span class="token punctuation">)</span>            line <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>            remainbytes <span class="token operator">-=</span> len<span class="token punctuation">(</span>line<span class="token punctuation">)</span>            <span class="token keyword">try</span><span class="token punctuation">:</span>                out <span class="token operator">=</span> open<span class="token punctuation">(</span>fn<span class="token punctuation">,</span> <span class="token string">'wb'</span><span class="token punctuation">)</span>            <span class="token keyword">except</span> IOError<span class="token punctuation">:</span>                <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">False</span><span class="token punctuation">,</span> <span class="token string">"Can't create file to write, do you have permission to write?"</span><span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">with</span> out<span class="token punctuation">:</span>                    preline <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>                    remainbytes <span class="token operator">-=</span> len<span class="token punctuation">(</span>preline<span class="token punctuation">)</span>                    <span class="token keyword">while</span> remainbytes <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>                        line <span class="token operator">=</span> self<span class="token punctuation">.</span>rfile<span class="token punctuation">.</span>readline<span class="token punctuation">(</span><span class="token punctuation">)</span>                        remainbytes <span class="token operator">-=</span> len<span class="token punctuation">(</span>line<span class="token punctuation">)</span>                        <span class="token keyword">if</span> boundary <span class="token keyword">in</span> line<span class="token punctuation">:</span>                            preline <span class="token operator">=</span> preline<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>                            <span class="token keyword">if</span> preline<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span>b<span class="token string">'\r'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                                preline <span class="token operator">=</span> preline<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">:</span><span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">]</span>                            out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>preline<span class="token punctuation">)</span>                            uploaded_files<span class="token punctuation">.</span>append<span class="token punctuation">(</span>fn<span class="token punctuation">)</span>                            <span class="token keyword">break</span>                        <span class="token keyword">else</span><span class="token punctuation">:</span>                            out<span class="token punctuation">.</span>write<span class="token punctuation">(</span>preline<span class="token punctuation">)</span>                            preline <span class="token operator">=</span> line        <span class="token keyword">return</span> <span class="token punctuation">(</span><span class="token boolean">True</span><span class="token punctuation">,</span> <span class="token string">"File '%s' upload success!"</span> <span class="token operator">%</span> <span class="token string">","</span><span class="token punctuation">.</span>join<span class="token punctuation">(</span>uploaded_files<span class="token punctuation">)</span><span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">send_head</span><span class="token punctuation">(</span>self<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Common code for GET and HEAD commands.        This sends the response code and MIME headers.        Return value is either a file object (which has to be copied        to the outputfile by the caller unless the command was HEAD,        and must be closed by the caller under all circumstances), or        None, in which case the caller has nothing further to do.        """</span>        path <span class="token operator">=</span> self<span class="token punctuation">.</span>translate_path<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span>        f <span class="token operator">=</span> None        <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token keyword">if</span> <span class="token operator">not</span> self<span class="token punctuation">.</span>path<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                <span class="token comment" spellcheck="true"># redirect browser - doing basically what apache does</span>                self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">301</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Location"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>path <span class="token operator">+</span> <span class="token string">"/"</span><span class="token punctuation">)</span>                self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>                <span class="token keyword">return</span> None            <span class="token keyword">for</span> index <span class="token keyword">in</span> <span class="token string">"index.html"</span><span class="token punctuation">,</span> <span class="token string">"index.htm"</span><span class="token punctuation">:</span>                index <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> index<span class="token punctuation">)</span>                <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">:</span>                    path <span class="token operator">=</span> index                    <span class="token keyword">break</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                <span class="token keyword">return</span> self<span class="token punctuation">.</span>list_directory<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        ctype <span class="token operator">=</span> self<span class="token punctuation">.</span>guess_type<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># Always read in binary mode. Opening files in text mode may cause</span>            <span class="token comment" spellcheck="true"># newline translations, making the actual size of the content</span>            <span class="token comment" spellcheck="true"># transmitted *less* than the content-length!</span>            f <span class="token operator">=</span> open<span class="token punctuation">(</span>path<span class="token punctuation">,</span> <span class="token string">'rb'</span><span class="token punctuation">)</span>        <span class="token keyword">except</span> IOError<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>send_error<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">"File not found"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> None        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> ctype<span class="token punctuation">)</span>        fs <span class="token operator">=</span> os<span class="token punctuation">.</span>fstat<span class="token punctuation">(</span>f<span class="token punctuation">.</span>fileno<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>fs<span class="token punctuation">[</span><span class="token number">6</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Last-Modified"</span><span class="token punctuation">,</span> self<span class="token punctuation">.</span>date_time_string<span class="token punctuation">(</span>fs<span class="token punctuation">.</span>st_mtime<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> f    <span class="token keyword">def</span> <span class="token function">list_directory</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Helper to produce a directory listing (absent index.html).        Return value is either a file object, or None (indicating an        error).  In either case, the headers are sent, making the        interface the same as for send_head().        """</span>        <span class="token keyword">try</span><span class="token punctuation">:</span>            list <span class="token operator">=</span> os<span class="token punctuation">.</span>listdir<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">except</span> os<span class="token punctuation">.</span>error<span class="token punctuation">:</span>            self<span class="token punctuation">.</span>send_error<span class="token punctuation">(</span><span class="token number">404</span><span class="token punctuation">,</span> <span class="token string">"No permission to list directory"</span><span class="token punctuation">)</span>            <span class="token keyword">return</span> None        list<span class="token punctuation">.</span>sort<span class="token punctuation">(</span>key<span class="token operator">=</span><span class="token keyword">lambda</span> a<span class="token punctuation">:</span> a<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        f <span class="token operator">=</span> BytesIO<span class="token punctuation">(</span><span class="token punctuation">)</span>        displaypath <span class="token operator">=</span> html<span class="token punctuation">.</span>escape<span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>self<span class="token punctuation">.</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'&lt;!DOCTYPE html PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"&lt;html>\n&lt;title>Directory listing for %s&lt;/title>\n"</span> <span class="token operator">%</span> displaypath<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'&lt;style type="text/css">\n'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'a &amp;#123; text-decoration: none; &amp;#125;\n'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'a:link &amp;#123; text-decoration: none; font-weight: bold; color: #0000ff; &amp;#125;\n'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'a:visited &amp;#123; text-decoration: none; font-weight: bold; color: #0000ff; &amp;#125;\n'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'a:active &amp;#123; text-decoration: none; font-weight: bold; color: #0000ff; &amp;#125;\n'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'a:hover &amp;#123; text-decoration: none; font-weight: bold; color: #ff0000; &amp;#125;\n'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'&lt;/style>\n'</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">"&lt;body>\n&lt;h2>Directory listing for %s&lt;/h2>\n"</span> <span class="token operator">%</span> displaypath<span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;hr>\n"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;form ENCTYPE=\"multipart/form-data\" method=\"post\">"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;input name=\"file\" type=\"file\" multiple/>"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;input type=\"submit\" value=\"upload\"/>&lt;/form>\n"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;hr>\n"</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">'&lt;a href="../">&lt;img src="data:image/gif;base64,R0lGODlhGAAYAMIAAP///7+/v7u7u1ZWVTc3NwAAAAAAAAAAACH+RFRoaXMgaWNvbiBpcyBpbiB0aGUgcHVibGljIGRvbWFpbi4gMTk5NSBLZXZpbiBIdWdoZXMsIGtldmluaEBlaXQuY29tACH5BAEAAAEALAAAAAAYABgAAANKGLrc/jBKNgIhM4rLcaZWd33KJnJkdaKZuXqTugYFeSpFTVpLnj86oM/n+DWGyCAuyUQymlDiMtrsUavP6xCizUB3NCW4Ny6bJwkAOw==" alt="[PARENTDIR]" width="24" height="24">&amp;nbsp;&amp;nbsp;&amp;nbsp;Parent Directory&lt;/a>&lt;br />\n'</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> name <span class="token keyword">in</span> list<span class="token punctuation">:</span>            dirimage <span class="token operator">=</span> <span class="token string">'data:image/gif;base64,R0lGODlhGAAYAMIAAP///7+/v7u7u1ZWVTc3NwAAAAAAAAAAACH+RFRoaXMgaWNvbiBpcyBpbiB0aGUgcHVibGljIGRvbWFpbi4gMTk5NSBLZXZpbiBIdWdoZXMsIGtldmluaEBlaXQuY29tACH5BAEAAAEALAAAAAAYABgAAANdGLrc/jAuQaulQwYBuv9cFnFfSYoPWXoq2qgrALsTYN+4QOg6veFAG2FIdMCCNgvBiAxWlq8mUseUBqGMoxWArW1xXYXWGv59b+WxNH1GV9vsNvd9jsMhxLw+70gAADs='</span>            fullname <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> name<span class="token punctuation">)</span>            displayname <span class="token operator">=</span> linkname <span class="token operator">=</span> name            <span class="token comment" spellcheck="true"># Append / for directories or @ for symbolic links</span>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>isdir<span class="token punctuation">(</span>fullname<span class="token punctuation">)</span><span class="token punctuation">:</span>                dirimage <span class="token operator">=</span> <span class="token string">'data:image/gif;base64,R0lGODlhGAAYAMIAAP///+jNlr+/v6KXfm5SG2lPGjc3NwAAACH+RFRoaXMgaWNvbiBpcyBpbiB0aGUgcHVibGljIGRvbWFpbi4gMTk5NSBLZXZpbiBIdWdoZXMsIGtldmluaEBlaXQuY29tACH5BAEAAAIALAAAAAAYABgAAANjKLrc/jDKSau9WJbN9y1BKIZFVQzjOHRdsw1wDIMpyYAFke9ELa4Lmm9IWBkUwqHPiFQSmYKkU1U4Rqe1YrWJTUGlWK0VjP12R2Jubx1guwPQqGxOj22DrLzeujD4/4CBgAoJADs='</span>                displayname <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">"/"</span>                linkname <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">"/"</span>            <span class="token keyword">if</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>islink<span class="token punctuation">(</span>fullname<span class="token punctuation">)</span><span class="token punctuation">:</span>                dirimage <span class="token operator">=</span> <span class="token string">'data:image/gif;base64,R0lGODlhGAAYAPf/AJaWlpqampubm5ycnJ2dnZ6enp+fn6CgoKGhoaKioqOjo6SkpKWlpaampqioqKmpqaqqqqurq6ysrK2tra6urq+vr7CwsLGxsbKysrOzs7S0tLW1tba2tre3t7i4uLm5ubq6uru7u7y8vL29vb6+vr+/v8LCwsPDw8bGxtDQ0NTU1NXV1dbW1tfX19jY2Nra2tzc3N3d3eDg4OHh4eLi4uPj4+Tk5OXl5efn5+np6erq6uvr6+zs7O7u7u/v7/Dw8PHx8fLy8vPz8/T09PX19fb29vf39/j4+Pr6+vv7+/39/f7+/v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAYAAAI/wCZCBxIsKDBgwgLrsigwUXChEVGYNBwIYKIJA8LFunwocKGDA8ieMg4kAiHDxRmCGyhIAEKkhtR2iCYYYEAkiNQ3ijYIQGAjDkuVFBJsIcBAhcyttCgoSCQBQcUFMn44gIFEiwE/oAqIAfJIREeQLDAZIeCAwO8IuQRowYSIxQgBFhAoQBatQaFiLCQoQIFCxEMREUwoAEPhEA0dMQwQSwCIEFYpKCR8IfiCjWYgJCr4AhJyx13CFRhQYECGBmRcKwgmmAEBCsyltBQQUfBGwUG4MjoYMOIgjsSIJBAskGGEAR3IEhw4AdJExIeyBCIY/kBHySZLNEwgcGGDQYQNBbPLpAIBgULEhB4AIQ8wRMFBIhQ4j4gADs='</span>                displayname <span class="token operator">=</span> name <span class="token operator">+</span> <span class="token string">"@"</span>            <span class="token keyword">if</span> name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.bmp'</span><span class="token punctuation">,</span><span class="token string">'.gif'</span><span class="token punctuation">,</span><span class="token string">'.jpg'</span><span class="token punctuation">,</span><span class="token string">'.png'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                dirimage <span class="token operator">=</span> name            <span class="token keyword">if</span> name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.avi'</span><span class="token punctuation">,</span><span class="token string">'.mpg'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                dirimage <span class="token operator">=</span> <span class="token string">'data:image/gif;base64,R0lGODlhGAAYAMIAAP///7+/v7u7u1ZWVTc3NwAAAAAAAAAAACH+RFRoaXMgaWNvbiBpcyBpbiB0aGUgcHVibGljIGRvbWFpbi4gMTk5NSBLZXZpbiBIdWdoZXMsIGtldmluaEBlaXQuY29tACH5BAEAAAEALAAAAAAYABgAAANvGLrc/jAuQqu99BEh8OXE4GzdYJ4mQIZjNXAwp7oj+MbyKjY6ntstyg03E9ZKPoEKyLMll6UgAUCtVi07xspTYWptqBOUxXM9scfQ2Ttx+sbZifmNbiLpbEUPHy1TrIB1Xx1cFHkBW4VODmGNjQ4JADs='</span>            <span class="token keyword">if</span> name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'.idx'</span><span class="token punctuation">,</span><span class="token string">'.srt'</span><span class="token punctuation">,</span><span class="token string">'.sub'</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                dirimage <span class="token operator">=</span> <span class="token string">'data:image/gif;base64,R0lGODlhGAAYAPf/AAAbDiAfDSoqHjQlADs+J3sxJ0BALERHMk5LN1pSPUZHRk9NQU1OR05ZUFBRRFVXTVdYTVtVQFlVRFtbSF5bTVZWUltbUFlZVFtcVlxdWl5eWl1gWmBiV2FiXWNhXGRjXWlpYmtqZ2xtZmxsaG5ubHJva3Jzb3J0bHN0b3Z5dHd8eXh4dX18dXx/dnt8e31+eahMP4JdWIdnZox4cpVoYKJkXrxqablwcNA6Otg7O/8AAPwHB/0GBvgODvsMDPMbG/ceHvkSEuYqKvYqKvU2NvM6OvQ6OsFQUNVbW8N4eNd0duNeXu9aWvFUVOVqau1jY+1mZu5mZuh5eYSFgIWGgYaFgIiGgYqKiY6LioyMiY2NiYyMio2OiI6OjZCSjZSQi5OSkJGUkpSVk5WVlJWVlZiZlpiZmJ6emp2dnZSko6GhnKGhoKOjoaKnoqSkpKSmpKWmpaampqqrqKurqKqrqq2sqq6urrSyrrCwsLa3tb63tbi4t7q6ur+/vsCbm96Li9iUlMqursmwr9KwsN69veSCguiMjOiOjuaQkOWVleaXmOGfn+aYmOaamuebm+adneecnOeenuiQkOWgoOWsrOasrOWxseW2tue3t+e8vOi+vsHBwcfHx8jIxs7Mx8nJyMvLy8zMy83NzM7Pzs/Pz9PR0dTU1NXV1dXW1tbW1tfX19bb29jY2NnZ2djb29ra2tvb2tvb29za2tzc3N3d3d7e3t/f3+bCwufDw+fGxuTJyejCwujHx+nHx+vPz+rT0+rU1OrX1+vX1+rY2Ojf3+Hh4eLi4uPj4+Hn5+Tk5OXl5ebm5ufn5+nn5+jo6Onp6erp6evr6+zs7PDn5/Dq6vDt7fHv7/Lu7vPu7vPv7/Dw8PHx8fLy8vPz8/Tx8fbz8/T09PX19fX39/b29vj39/j4+Pn4+Pn5+fr5+fr6+vv7+/z7+/z8/P39/f7+/v/+/v///wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAYAAAI/wDhCRxIsKDBgwgTZis00F27hAbRNSpSaSC7ZM6ePQsXjdmzZekKUpOio0lBVShjJXvYjp07gsEm/dLhqKC2aNG2LesES13BXJTg4dLBi2C7kPDSyQFTRY26c8akZbolkJGOaQTZFTO2LA8KCCA+zDFTp4aggVCCmCtYrJUxNiI4nAjh4o2HGW1CrhvCxGC5cOVqvcCgQQUWGRtanOkG75qOQwXbhWvZ7lOZMIGSsJjihY5AYTowFWRnipUtT6BGWIARY8IXPc1eXtIxrKC7cqJCjdJCIcIBAwRoaLqU6IkRHthGnwPzoEGKDBISMHDAZWAvHUTWjaa1J42NAgAELMBAMGCNwHbWekQxqA4VMkBKSokZE8AKtHLpjuHxo0OSQXfuLKJIOHdc0IECFaxgQivpxHGDDpYc9McS5oBTAhxUbNHFFX2I4Q4fR+iwi0GPCCGLK6rYgQYJWZDhBil7cMMJDjpAAg85L8ETCRDVqAONMuGMA0446rDjEzzi5KDDD4j48g48huxAyCqtODNZOeWcM85DAxEDzDcE+YDEK5u0EostbZ2SyizsQASPE4PAo4466TxVZzptuqmLN266GRAAOw=='</span>            <span class="token keyword">if</span> name<span class="token punctuation">.</span>endswith<span class="token punctuation">(</span><span class="token string">'.iso'</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                dirimage <span class="token operator">=</span> <span class="token string">'data:image/gif;base64,R0lGODlhGAAYAPf/AKysrLGxsbe3t7i4uLm5uLm5ubq6ury8vL29vb6+vry+wb2+wKfeu7XGsbjNtr3UprnVqbbcvqjOzKTM0KbdwKvX2anZ1b/CxbTbw63R5LHS5b3T5dexrtuxrty+p+KvpOCxo8bLnsvJotjAptTPs9HRtcDAwMHBwcLCwsPDw8PCxMLDxsTDwsTEw8TExMXFxcbGxsfHx8jIyMnJycrJysrKysvLy87Ly8zMzM3Nzc7Ozs/PzsDe3NDQ0NHR0dLR0NLS0tPT09TU1NXV1dXW1tbW1tfX19HZ0dLb0NjV1NrW1djY2NnZ2dra2t3a2tzc3N3d3d7e3d/f3t/f38HU5cPf6sff68/e69Pf6sDi3Nng59zh5d7k5ujEw+nFxOnGxunIx+vLx+zNyePTy+Hf3+3Y0eDg3+Tg3+Dg4OHh4uLi4eLi4uPj4uPj4+Hj5OPk4+Th4OTk4+Tk5OXl5OXl5eXm5ebl5Obm5ebm5ubn5ufn5ufn5+Lm6uXo6unj4+rl5Ojo5+jo6Onp6Onp6erq6erq6urr6+vr6uvr6+vs6+zp6e3r6uzs6+zs7O3t7e3u7e7u7e7u7u/v7u/v7+fv9ezu8e3u8PDp6fHr6/Dw8PHx8PHx8fLy8fLy8vPy8vPz8vPz8/Tz8/T08/T09PX19PX19fX29fb19Pb29vf39vf39/j49/j4+Pn4+Pn5+Pn5+fr6+fr6+vv7+vv7+/z8+/z8/P39/P39/f7+/f7+/v7//////wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAACwAAAAAGAAYAAAI/wB3CRxIsKBBg4hi6GCyBs+eQIH2PJSIB82QGYgKDnqBowmeRpEiTSo0qVGmSI3oGJkxSOOLGkXkIJpkBEEQHzagZEq5siXBjTOGtJnpwweKBFCE7FTJ0mXQoZH2TIGCh4kjR4jkFGn684UMIXIGTWkSpQ0bOTIbaa3hc+BGGUSeFIkyhxCkT6hKDaKztq3AQS5m3EgSZw4gRplIvbq1KxIUI2w1umDBAQycPIQkgVo1K9etWXSARP6pooGID1/+POKEKtatXLFSfQLCdWChBRIYPPAgBpMpVrV20WIFKpMUF4UKElKwIYOFCCTKKCrUSBWsUpkY3WmR/KcLN1quVPLJgmTRrViBPHlyJAgPDL+7BsW4AyhRJUpcQO3S1YePpUN62FHbXy/sUYgkobQiCSKvnHIED1ZgscUb72l0gh6OsCYLLY60QcYYJWBQgQZUXEBIQYWYYAYnitmSCy2ldHJJGCNAQMEEK3TnVgo5jMJZLra8UoomjfjRBQghOEADfIW88AIdtdyCSyyocMJeHWd40cEPA+4SSGA+TLJLLauAIkkhesgRhxJOLCHDHgXhwVETbTjCiiuiSHIIIGo8UYghTcyAR0GgyDCAAAYMEMAJO/QwAwEAFHCAAQXIMMpBmzhSyCCD4JHGFA0FMkghMxEUEAA7'</span>            <span class="token comment" spellcheck="true"># Note: a link to a directory displays with @ and links with /</span>            f<span class="token punctuation">.</span>write<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token string">'&lt;a href="%s">&lt;img src="%s" width="24" height="24">&amp;nbsp;&amp;nbsp;&amp;nbsp;%s&lt;/a>&lt;br />\n'</span>                    <span class="token operator">%</span> <span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>quote<span class="token punctuation">(</span>linkname<span class="token punctuation">)</span><span class="token punctuation">,</span> dirimage <span class="token punctuation">,</span> html<span class="token punctuation">.</span>escape<span class="token punctuation">(</span>displayname<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>encode<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>write<span class="token punctuation">(</span>b<span class="token string">"&lt;hr>\n&lt;/body>\n&lt;/html>\n"</span><span class="token punctuation">)</span>        length <span class="token operator">=</span> f<span class="token punctuation">.</span>tell<span class="token punctuation">(</span><span class="token punctuation">)</span>        f<span class="token punctuation">.</span>seek<span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_response<span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Content-type"</span><span class="token punctuation">,</span> <span class="token string">"text/html"</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>send_header<span class="token punctuation">(</span><span class="token string">"Content-Length"</span><span class="token punctuation">,</span> str<span class="token punctuation">(</span>length<span class="token punctuation">)</span><span class="token punctuation">)</span>        self<span class="token punctuation">.</span>end_headers<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">return</span> f    <span class="token keyword">def</span> <span class="token function">translate_path</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Translate a /-separated PATH to the local filename syntax.        Components that mean special things to the local file system        (e.g. drive or directory names) are ignored.  (XXX They should        probably be diagnosed.)        """</span>        <span class="token comment" spellcheck="true"># abandon query parameters</span>        path <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'?'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        path <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'#'</span><span class="token punctuation">,</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>        path <span class="token operator">=</span> posixpath<span class="token punctuation">.</span>normpath<span class="token punctuation">(</span>urllib<span class="token punctuation">.</span>parse<span class="token punctuation">.</span>unquote<span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">)</span>        words <span class="token operator">=</span> path<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token string">'/'</span><span class="token punctuation">)</span>        words <span class="token operator">=</span> <span class="token punctuation">[</span>_f <span class="token keyword">for</span> _f <span class="token keyword">in</span> words <span class="token keyword">if</span> _f<span class="token punctuation">]</span>        path <span class="token operator">=</span> os<span class="token punctuation">.</span>getcwd<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">for</span> word <span class="token keyword">in</span> words<span class="token punctuation">:</span>            drive<span class="token punctuation">,</span> word <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>splitdrive<span class="token punctuation">(</span>word<span class="token punctuation">)</span>            head<span class="token punctuation">,</span> word <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>split<span class="token punctuation">(</span>word<span class="token punctuation">)</span>            <span class="token keyword">if</span> word <span class="token keyword">in</span> <span class="token punctuation">(</span>os<span class="token punctuation">.</span>curdir<span class="token punctuation">,</span> os<span class="token punctuation">.</span>pardir<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token keyword">continue</span>            path <span class="token operator">=</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>join<span class="token punctuation">(</span>path<span class="token punctuation">,</span> word<span class="token punctuation">)</span>        <span class="token keyword">return</span> path    <span class="token keyword">def</span> <span class="token function">copyfile</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> source<span class="token punctuation">,</span> outputfile<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Copy all data between two file objects.        The SOURCE argument is a file object open for reading        (or anything with a read() method) and the DESTINATION        argument is a file object open for writing (or        anything with a write() method).        The only reason for overriding this would be to change        the block size or perhaps to replace newlines by CRLF        -- note however that this the default server uses this        to copy binary data as well.        """</span>        shutil<span class="token punctuation">.</span>copyfileobj<span class="token punctuation">(</span>source<span class="token punctuation">,</span> outputfile<span class="token punctuation">)</span>    <span class="token keyword">def</span> <span class="token function">guess_type</span><span class="token punctuation">(</span>self<span class="token punctuation">,</span> path<span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token triple-quoted-string string">"""Guess the type of a file.        Argument is a PATH (a filename).        Return value is a string of the form type/subtype,        usable for a MIME Content-type header.        The default implementation looks the file's extension        up in the table self.extensions_map, using application/octet-stream        as a default; however it would be permissible (if        slow) to look inside the data to make a better guess.        """</span>        base<span class="token punctuation">,</span> ext <span class="token operator">=</span> posixpath<span class="token punctuation">.</span>splitext<span class="token punctuation">(</span>path<span class="token punctuation">)</span>        <span class="token keyword">if</span> ext <span class="token keyword">in</span> self<span class="token punctuation">.</span>extensions_map<span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>extensions_map<span class="token punctuation">[</span>ext<span class="token punctuation">]</span>        ext <span class="token operator">=</span> ext<span class="token punctuation">.</span>lower<span class="token punctuation">(</span><span class="token punctuation">)</span>        <span class="token keyword">if</span> ext <span class="token keyword">in</span> self<span class="token punctuation">.</span>extensions_map<span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>extensions_map<span class="token punctuation">[</span>ext<span class="token punctuation">]</span>        <span class="token keyword">else</span><span class="token punctuation">:</span>            <span class="token keyword">return</span> self<span class="token punctuation">.</span>extensions_map<span class="token punctuation">[</span><span class="token string">''</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token operator">not</span> mimetypes<span class="token punctuation">.</span>inited<span class="token punctuation">:</span>        mimetypes<span class="token punctuation">.</span>init<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment" spellcheck="true"># try to read system mime.types</span>    extensions_map <span class="token operator">=</span> mimetypes<span class="token punctuation">.</span>types_map<span class="token punctuation">.</span>copy<span class="token punctuation">(</span><span class="token punctuation">)</span>    extensions_map<span class="token punctuation">.</span>update<span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;</span>        <span class="token string">''</span><span class="token punctuation">:</span> <span class="token string">'application/octet-stream'</span><span class="token punctuation">,</span> <span class="token comment" spellcheck="true"># Default</span>        <span class="token string">'.py'</span><span class="token punctuation">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span>        <span class="token string">'.c'</span><span class="token punctuation">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span>        <span class="token string">'.h'</span><span class="token punctuation">:</span> <span class="token string">'text/plain'</span><span class="token punctuation">,</span>        <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#125;)</span>parser <span class="token operator">=</span> argparse<span class="token punctuation">.</span>ArgumentParser<span class="token punctuation">(</span><span class="token punctuation">)</span>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'--bind'</span><span class="token punctuation">,</span> <span class="token string">'-b'</span><span class="token punctuation">,</span> default<span class="token operator">=</span><span class="token string">''</span><span class="token punctuation">,</span> metavar<span class="token operator">=</span><span class="token string">'ADDRESS'</span><span class="token punctuation">,</span>                        help<span class="token operator">=</span><span class="token string">'Specify alternate bind address '</span>                             <span class="token string">'[default: all interfaces]'</span><span class="token punctuation">)</span>parser<span class="token punctuation">.</span>add_argument<span class="token punctuation">(</span><span class="token string">'port'</span><span class="token punctuation">,</span> action<span class="token operator">=</span><span class="token string">'store'</span><span class="token punctuation">,</span>                        default<span class="token operator">=</span><span class="token number">8000</span><span class="token punctuation">,</span> type<span class="token operator">=</span>int<span class="token punctuation">,</span>                        nargs<span class="token operator">=</span><span class="token string">'?'</span><span class="token punctuation">,</span>                        help<span class="token operator">=</span><span class="token string">'Specify alternate port [default: 8000]'</span><span class="token punctuation">)</span>args <span class="token operator">=</span> parser<span class="token punctuation">.</span>parse_args<span class="token punctuation">(</span><span class="token punctuation">)</span>PORT <span class="token operator">=</span> args<span class="token punctuation">.</span>portBIND <span class="token operator">=</span> args<span class="token punctuation">.</span>bindHOST <span class="token operator">=</span> BIND<span class="token keyword">if</span> HOST <span class="token operator">==</span> <span class="token string">''</span><span class="token punctuation">:</span>    HOST <span class="token operator">=</span> <span class="token string">'localhost'</span>Handler <span class="token operator">=</span> SimpleHTTPRequestHandler<span class="token keyword">with</span> socketserver<span class="token punctuation">.</span>TCPServer<span class="token punctuation">(</span><span class="token punctuation">(</span>BIND<span class="token punctuation">,</span> PORT<span class="token punctuation">)</span><span class="token punctuation">,</span> Handler<span class="token punctuation">)</span> <span class="token keyword">as</span> httpd<span class="token punctuation">:</span>    serve_message <span class="token operator">=</span> <span class="token string">"Serving HTTP on &amp;#123;host&amp;#125; port &amp;#123;port&amp;#125; (http://&amp;#123;host&amp;#125;:&amp;#123;port&amp;#125;/) ..."</span>    <span class="token keyword">print</span><span class="token punctuation">(</span>serve_message<span class="token punctuation">.</span>format<span class="token punctuation">(</span>host<span class="token operator">=</span>HOST<span class="token punctuation">,</span> port<span class="token operator">=</span>PORT<span class="token punctuation">)</span><span class="token punctuation">)</span>    httpd<span class="token punctuation">.</span>serve_forever<span class="token punctuation">(</span><span class="token punctuation">)</span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> python、文件传输 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>将csv转为对应的灰度图</title>
      <link href="2021/08/16/jiang-csv-zhuan-wei-dui-ying-de-hui-du-tu/"/>
      <url>2021/08/16/jiang-csv-zhuan-wei-dui-ying-de-hui-du-tu/</url>
      
        <content type="html"><![CDATA[<h2 id="目录"><a href="#目录" class="headerlink" title="目录"></a>目录</h2><h3 id="前述"><a href="#前述" class="headerlink" title="前述"></a>前述</h3><p>听着好像有点多余，原本就是要把灰度图转为csv来读取。。</p><h3 id="代码"><a href="#代码" class="headerlink" title="代码"></a>代码</h3><p>代码功能详见注释</p><pre class=" language-python"><code class="language-python"><span class="token keyword">import</span> numpy <span class="token keyword">as</span> np<span class="token keyword">import</span> os<span class="token keyword">from</span> PIL <span class="token keyword">import</span> Image<span class="token keyword">import</span> cv2<span class="token keyword">import</span> matplotlib<span class="token punctuation">.</span>pyplot <span class="token keyword">as</span> plt<span class="token keyword">from</span> tqdm <span class="token keyword">import</span> tqdm<span class="token keyword">import</span> pandas <span class="token keyword">as</span> pd<span class="token comment" spellcheck="true">#from config import *</span><span class="token keyword">import</span> dlib<span class="token comment" spellcheck="true">#********************check over</span><span class="token comment" spellcheck="true"># 目的是实现从csv到jpg的转换</span><span class="token comment" spellcheck="true"># conver_csv_to_jpg是实现转换</span><span class="token comment" spellcheck="true"># crop_face_area是实现ROI区域的提取</span><span class="token keyword">def</span> <span class="token function">convert_csv_to_jpg</span><span class="token punctuation">(</span>csv_path<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token comment" spellcheck="true"># 加载opencv的人脸识别文件</span>    <span class="token comment" spellcheck="true"># 'haarcascade_frontalface_alt' 的准确度更高，但是速度更慢</span>    <span class="token comment" spellcheck="true"># 'haarcascade_frontalface_default' 准确度较低，但是更快而且更轻巧</span>    <span class="token comment" spellcheck="true"># detector = cv2.CascadeClassifier(haarcascade_frontalface_alt)</span>    detector <span class="token operator">=</span> dlib<span class="token punctuation">.</span>get_frontal_face_detector<span class="token punctuation">(</span><span class="token punctuation">)</span>    landmark_predictor <span class="token operator">=</span> dlib<span class="token punctuation">.</span>shape_predictor<span class="token punctuation">(</span>        <span class="token string">'D:\\realsense_window\\CNN-Facial-Expression-Recognition-master\\data\\shape_predictor_68_face_landmarks.dat'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 将csv通过PIL转换为jpg</span>    data <span class="token operator">=</span> pd<span class="token punctuation">.</span>read_csv<span class="token punctuation">(</span>csv_path<span class="token punctuation">,</span> encoding<span class="token operator">=</span><span class="token string">"ISO-8859-1"</span><span class="token punctuation">)</span>    train_path_data <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;'path': [], 'emotion': []&amp;#125;</span>    valid_path_data <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;'path': [], 'emotion': []&amp;#125;</span>    test_path_data <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token comment" spellcheck="true">#123;'path': [], 'emotion': []&amp;#125;</span>    train_landmark <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    valid_landmark <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    test_landmark <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>TRAIN_DIR<span class="token punctuation">)</span><span class="token punctuation">:</span>        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>TRAIN_DIR<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>TEST_DIR<span class="token punctuation">)</span><span class="token punctuation">:</span>        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>TEST_DIR<span class="token punctuation">)</span>    <span class="token keyword">if</span> <span class="token operator">not</span> os<span class="token punctuation">.</span>path<span class="token punctuation">.</span>exists<span class="token punctuation">(</span>VALID_DIR<span class="token punctuation">)</span><span class="token punctuation">:</span>        os<span class="token punctuation">.</span>mkdir<span class="token punctuation">(</span>VALID_DIR<span class="token punctuation">)</span>    total <span class="token operator">=</span> <span class="token number">0</span>    <span class="token comment" spellcheck="true"># 将cssv文件中的数据如emotion，pixel，usage打包成之后读取，同时需要处理多个数据的常用手段</span>    <span class="token keyword">for</span> label<span class="token punctuation">,</span> pixels<span class="token punctuation">,</span> usage <span class="token keyword">in</span> tqdm<span class="token punctuation">(</span>zip<span class="token punctuation">(</span>data<span class="token punctuation">[</span><span class="token string">'emotion'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'pixels'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> data<span class="token punctuation">[</span><span class="token string">'Usage'</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">:</span>        <span class="token comment" spellcheck="true"># 修改文件为指定大小</span>        img <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>pixels<span class="token punctuation">.</span>split<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>astype<span class="token punctuation">(</span>            np<span class="token punctuation">.</span>int32<span class="token punctuation">)</span><span class="token punctuation">.</span>reshape<span class="token punctuation">(</span><span class="token punctuation">[</span>img_size<span class="token punctuation">,</span> img_size<span class="token punctuation">]</span><span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 裁剪文件为所需要的人脸部分</span>        all_faces<span class="token punctuation">,</span> all_landmarks <span class="token operator">=</span> crop_face_area<span class="token punctuation">(</span>            detector<span class="token punctuation">,</span> landmark_predictor<span class="token punctuation">,</span> img<span class="token punctuation">,</span> img_size<span class="token punctuation">)</span>        <span class="token keyword">if</span> all_faces <span class="token keyword">is</span> None<span class="token punctuation">:</span>            <span class="token keyword">continue</span>        <span class="token keyword">for</span> img<span class="token punctuation">,</span> landmarks <span class="token keyword">in</span> zip<span class="token punctuation">(</span>all_faces<span class="token punctuation">,</span> all_landmarks<span class="token punctuation">)</span><span class="token punctuation">:</span>            <span class="token comment" spellcheck="true"># fromarray可以说明img此时为np的矩阵格式，Image中的fromarray这个函数实现从矩阵保存的像素值到照片的转换</span>            img <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>img<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'L'</span><span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 转为单通道</span>            fname <span class="token operator">=</span> str<span class="token punctuation">(</span>total<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">'.jpg'</span>  <span class="token comment" spellcheck="true"># filename的格式</span>            <span class="token comment" spellcheck="true"># fer2013.csv中已经实现将各个csv文件的对应内容写好，包括pixel(与转换为照片有关)，emotion(0-6对应于不同的情绪)，usage对应于training，testing，validing</span>            <span class="token keyword">if</span> usage <span class="token operator">==</span> <span class="token string">'Training'</span><span class="token punctuation">:</span>                save_path <span class="token operator">=</span> TRAIN_DIR <span class="token operator">+</span> <span class="token string">'\\'</span> <span class="token operator">+</span> fname  <span class="token comment" spellcheck="true"># 文件的保存路径</span>                train_path_data<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>                train_path_data<span class="token punctuation">[</span><span class="token string">'emotion'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>                train_landmark<span class="token punctuation">.</span>append<span class="token punctuation">(</span>landmarks<span class="token punctuation">)</span>            <span class="token keyword">elif</span> usage <span class="token operator">==</span> <span class="token string">'PrivateTest'</span><span class="token punctuation">:</span>                save_path <span class="token operator">=</span> VALID_DIR <span class="token operator">+</span> <span class="token string">'\\'</span> <span class="token operator">+</span> fname                valid_path_data<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>                valid_path_data<span class="token punctuation">[</span><span class="token string">'emotion'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>                valid_landmark<span class="token punctuation">.</span>append<span class="token punctuation">(</span>landmarks<span class="token punctuation">)</span>            <span class="token keyword">else</span><span class="token punctuation">:</span>                save_path <span class="token operator">=</span> TEST_DIR <span class="token operator">+</span> <span class="token string">'\\'</span> <span class="token operator">+</span> fname                test_path_data<span class="token punctuation">[</span><span class="token string">'path'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>fname<span class="token punctuation">)</span>                test_path_data<span class="token punctuation">[</span><span class="token string">'emotion'</span><span class="token punctuation">]</span><span class="token punctuation">.</span>append<span class="token punctuation">(</span>label<span class="token punctuation">)</span>                test_landmark<span class="token punctuation">.</span>append<span class="token punctuation">(</span>landmarks<span class="token punctuation">)</span>            img<span class="token punctuation">.</span>save<span class="token punctuation">(</span>save_path<span class="token punctuation">)</span>            total <span class="token operator">+=</span> <span class="token number">1</span>    <span class="token comment" spellcheck="true"># 将train_landmark中的内容转为array格式，np.asarray(file，dtype=floatxx，ord)</span>    train_landmark <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>train_landmark<span class="token punctuation">)</span>    valid_landmark <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>valid_landmark<span class="token punctuation">)</span>    test_landmark <span class="token operator">=</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>test_landmark<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>savez<span class="token punctuation">(</span>TRAIN_LANDMARK_PATH<span class="token punctuation">,</span> landmark<span class="token operator">=</span>train_landmark<span class="token punctuation">)</span>  <span class="token comment" spellcheck="true"># 生成npz的压缩文件</span>    np<span class="token punctuation">.</span>savez<span class="token punctuation">(</span>VALID_LANDMARK_PATH<span class="token punctuation">,</span> landmark<span class="token operator">=</span>valid_landmark<span class="token punctuation">)</span>    np<span class="token punctuation">.</span>savez<span class="token punctuation">(</span>TEST_LANDMARK_PATH<span class="token punctuation">,</span> landmark<span class="token operator">=</span>test_landmark<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># dataframe是pandas的存储数据的方式，类似与matlab的矩阵和excel的表格，第一个参数与是用于存储的数据，可以是字符什么的，</span>    <span class="token comment" spellcheck="true"># 第二个数据index和第三个数据column分别代表行和列的标记，注意长度要和所给数据的行列大小一致</span>    <span class="token comment" spellcheck="true"># 例如df=pd.DataFrame([[1,2,3,4],[2,3,4,5],</span>    <span class="token comment" spellcheck="true">#              [3,4,5,6]，[4,5,6,7]],</span>    <span class="token comment" spellcheck="true">#             index=list('ABCD'),columns=list('ABCD'))</span>    <span class="token comment" spellcheck="true"># df=</span>    <span class="token triple-quoted-string string">'''A  B  C  D    A  1  2  3  4    B  2  3  4  5    C  3  4  5  6    D  4  5  6  7    '''</span>    train_path_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>train_path_data<span class="token punctuation">)</span>    train_path_data<span class="token punctuation">.</span>to_pickle<span class="token punctuation">(</span>TRAIN_PATH<span class="token punctuation">)</span>    valid_path_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>valid_path_data<span class="token punctuation">)</span>    valid_path_data<span class="token punctuation">.</span>to_pickle<span class="token punctuation">(</span>VALID_PATH<span class="token punctuation">)</span>    test_path_data <span class="token operator">=</span> pd<span class="token punctuation">.</span>DataFrame<span class="token punctuation">(</span>test_path_data<span class="token punctuation">)</span>    test_path_data<span class="token punctuation">.</span>to_pickle<span class="token punctuation">(</span>TEST_PATH<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 输出training，testing，validing中文件的个数</span>    <span class="token keyword">print</span><span class="token punctuation">(</span><span class="token string">'Total: &amp;#123;&amp;#125;, training: &amp;#123;&amp;#125;, valid: &amp;#123;&amp;#125;, test: &amp;#123;&amp;#125;'</span><span class="token punctuation">.</span>format<span class="token punctuation">(</span>        total<span class="token punctuation">,</span> len<span class="token punctuation">(</span>train_path_data<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>valid_path_data<span class="token punctuation">)</span><span class="token punctuation">,</span> len<span class="token punctuation">(</span>test_path_data<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token keyword">def</span> <span class="token function">crop_face_area</span><span class="token punctuation">(</span>detector<span class="token punctuation">,</span> landmark_predictor<span class="token punctuation">,</span> image<span class="token punctuation">,</span> img_size<span class="token punctuation">)</span><span class="token punctuation">:</span>    <span class="token triple-quoted-string string">"""    裁剪图像的人脸部分，并resize到img_size尺寸    :param detector:    :param image:    :param img_size:    :return: Two numpy arrays containing the area and landmarks of all faces.    None if no face was detected.    """</span>    <span class="token comment" spellcheck="true"># p_img = Image.fromarray(image).convert(mode='RGB')</span>    <span class="token comment" spellcheck="true"># cv_img = cv2.cvtColor(np.asarray(p_img), cv2.COLOR_RGB2GRAY)</span>    <span class="token comment" spellcheck="true"># faces = detector.detectMultiScale(</span>    <span class="token comment" spellcheck="true">#     image=cv_img,</span>    <span class="token comment" spellcheck="true">#     scaleFactor=1.1,</span>    <span class="token comment" spellcheck="true">#     minNeighbors=1,</span>    <span class="token comment" spellcheck="true">#     minSize=(30, 30),</span>    <span class="token comment" spellcheck="true">#     flags=0</span>    <span class="token comment" spellcheck="true"># )</span>    <span class="token comment" spellcheck="true"># if len(faces) != 0:</span>    <span class="token comment" spellcheck="true">#     x, y, w, h = faces[0]</span>    <span class="token comment" spellcheck="true">#     cv_img = cv2.resize(cv_img[x:x + w, y:y + h], (img_size, img_size))</span>    <span class="token comment" spellcheck="true">#     return np.asarray(cv_img)</span>    <span class="token comment" spellcheck="true"># else:</span>    <span class="token comment" spellcheck="true">#     return None</span>    <span class="token comment" spellcheck="true"># 将image从np.array转化为RGB的照片的格式</span>    p_img <span class="token operator">=</span> Image<span class="token punctuation">.</span>fromarray<span class="token punctuation">(</span>image<span class="token punctuation">)</span><span class="token punctuation">.</span>convert<span class="token punctuation">(</span>mode<span class="token operator">=</span><span class="token string">'RGB'</span><span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 将P_img从ＲＧＢ转为灰度图</span>    cv_img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>cvtColor<span class="token punctuation">(</span>np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>p_img<span class="token punctuation">)</span><span class="token punctuation">,</span> cv2<span class="token punctuation">.</span>COLOR_RGB2GRAY<span class="token punctuation">)</span>    <span class="token comment" spellcheck="true"># 检测灰度图cv_img中的人脸</span>    faces <span class="token operator">=</span> detector<span class="token punctuation">(</span>cv_img<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span>    all_landmarks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    all_faces <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>    <span class="token keyword">if</span> len<span class="token punctuation">(</span>faces<span class="token punctuation">)</span> <span class="token operator">></span> <span class="token number">0</span><span class="token punctuation">:</span>        <span class="token keyword">for</span> face <span class="token keyword">in</span> faces<span class="token punctuation">:</span>            shape <span class="token operator">=</span> landmark_predictor<span class="token punctuation">(</span>cv_img<span class="token punctuation">,</span> face<span class="token punctuation">)</span>            landmarks <span class="token operator">=</span> np<span class="token punctuation">.</span>ndarray<span class="token punctuation">(</span>shape<span class="token operator">=</span><span class="token punctuation">[</span><span class="token number">68</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">)</span>            <span class="token keyword">for</span> i <span class="token keyword">in</span> range<span class="token punctuation">(</span><span class="token number">68</span><span class="token punctuation">)</span><span class="token punctuation">:</span>                landmarks<span class="token punctuation">[</span>i<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span>shape<span class="token punctuation">.</span>part<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>x<span class="token punctuation">,</span> shape<span class="token punctuation">.</span>part<span class="token punctuation">(</span>i<span class="token punctuation">)</span><span class="token punctuation">.</span>y<span class="token punctuation">)</span>            all_landmarks<span class="token punctuation">.</span>append<span class="token punctuation">(</span>landmarks<span class="token punctuation">)</span>            x1<span class="token punctuation">,</span> y1<span class="token punctuation">,</span> x2<span class="token punctuation">,</span> y2 <span class="token operator">=</span> face<span class="token punctuation">.</span>left<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> face<span class="token punctuation">.</span>top<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> face<span class="token punctuation">.</span>right<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> face<span class="token punctuation">.</span>bottom<span class="token punctuation">(</span><span class="token punctuation">)</span>            <span class="token comment" spellcheck="true"># 裁剪照片多余的部分</span>            <span class="token keyword">if</span> x1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>                x1 <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">if</span> x1 <span class="token operator">></span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                x1 <span class="token operator">=</span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> x2 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>                x2 <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">if</span> x2 <span class="token operator">></span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                x2 <span class="token operator">=</span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> y1 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>                y1 <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">if</span> y1 <span class="token operator">></span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                y1 <span class="token operator">=</span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            <span class="token keyword">if</span> y2 <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">:</span>                y2 <span class="token operator">=</span> <span class="token number">0</span>            <span class="token keyword">if</span> y2 <span class="token operator">></span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">:</span>                y2 <span class="token operator">=</span> cv_img<span class="token punctuation">.</span>shape<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span>            img <span class="token operator">=</span> cv2<span class="token punctuation">.</span>resize<span class="token punctuation">(</span>cv_img<span class="token punctuation">[</span>y1<span class="token punctuation">:</span>y2<span class="token punctuation">,</span> x1<span class="token punctuation">:</span>x2<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>img_size<span class="token punctuation">,</span> img_size<span class="token punctuation">)</span><span class="token punctuation">)</span>            all_faces<span class="token punctuation">.</span>append<span class="token punctuation">(</span>img<span class="token punctuation">)</span>        <span class="token comment" spellcheck="true"># 返回每张照片img中的人脸所在的位置</span>        <span class="token keyword">return</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>all_faces<span class="token punctuation">)</span><span class="token punctuation">,</span> np<span class="token punctuation">.</span>asarray<span class="token punctuation">(</span>all_landmarks<span class="token punctuation">)</span>    <span class="token keyword">else</span><span class="token punctuation">:</span>        <span class="token keyword">return</span> None<span class="token punctuation">,</span> None<span class="token triple-quoted-string string">'''def count_lines(csv_path):    data = pd.read_csv(csv_path, encoding="ISO-8859-1")    return data.shape[0]    #data.shape[0]代表csv文件中有多少行，也即有多少张照片'''</span><span class="token triple-quoted-string string">'''def show_class_distribution(file_path):    label_num = np.zeros([7], dtype=np.int32)    data = pd.read_csv(file_path)    for label in data['emotion']:        label_num[label] += 1  # get the name of emotions alreay-known    rects = plt.bar(class_names, label_num)    plt.title('Label Distribution')    plt.xlabel("Label")    plt.ylabel("Number")    for rect in rects:        height = rect.get_height()        plt.text(rect.get_x() + rect.get_width() / 2, height +                 1, str(height), ha="center", va="bottom")    plt.show()'''</span><span class="token keyword">if</span> __name__ <span class="token operator">==</span> <span class="token string">'__main__'</span><span class="token punctuation">:</span>    DATA_PATH <span class="token operator">=</span> <span class="token string">'D:\\2019-10-19\\csv\\fer2013_2.csv'</span>    convert_csv_to_jpg<span class="token punctuation">(</span>DATA_PATH<span class="token punctuation">)</span></code></pre>]]></content>
      
      
      
        <tags>
            
            <tag> python </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
